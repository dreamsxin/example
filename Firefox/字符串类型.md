```c++
/************************************************************************
** TYPES:       PRUint32
**              PRInt32
** DESCRIPTION:
**  The int32 types are known to be 32 bits each.
************************************************************************/
#if PR_BYTES_PER_INT == 4
typedef unsigned int PRUint32;
typedef int PRInt32;
#define PR_INT32(x)  x
#define PR_UINT32(x) x ## U
#elif PR_BYTES_PER_LONG == 4
typedef unsigned long PRUint32;
typedef long PRInt32;
#define PR_INT32(x)  x ## L
#define PR_UINT32(x) x ## UL
#else
#error No suitable type for PRInt32/PRUint32
#endif
```

```c++
// We template this so that the constructor is chosen based on the type of the
// parameter. This allows us to reject attempts to promise a flat flat string.
template <class T>
const nsTPromiseFlatString<T> TPromiseFlatString(
    const typename nsTPromiseFlatString<T>::substring_type& aString) {
  return nsTPromiseFlatString<T>(aString);
}

template <class T>
const nsTPromiseFlatString<T> TPromiseFlatString(
    const typename nsTPromiseFlatString<T>::substring_tuple_type& aString) {
  return nsTPromiseFlatString<T>(aString);
}

#ifndef PromiseFlatCString
#  define PromiseFlatCString TPromiseFlatString<char>
#endif

#ifndef PromiseFlatString
#  define PromiseFlatString TPromiseFlatString<char16_t>
#endif
```

# 字符串

字符串有两种基本的存储格式:
- `8-bit code unit (byte/char)` 字符串
- `16-bit code unit (PRUnichar)` 字符串
所有带大写C开头的字符串类都是 8-bit 的. 当然所有不含大写C开头的字符串类都是16字节的。

`8-bit` 的字符串可以使用N多编码，但是16-bit的字符串永远都是使用UTF-16编码。最常见的编码格式如下：
- ASCII - 8-bit encoding for basic English-only strings.
内部使用，一般采用这种格式
- UCS2 - 16-bit encoding for a subset of Unicode, BMP.
- UTF-8 - 8-bit encoding for Unicode characters. 
- UTF-16 - 16-bit encoding for Unicode storage, backwards compatible with UCS2. 

## 编码转码

### UTF-8 / UTF-16 conversion

- NS_ConvertUTF8toUTF16(const nsACString&)
- NS_ConvertUTF8toUTF16(utf8String).get()
`UTF-16` 转为 `UTF-8`，使用 `.get` 获得 `const char* buffer`
- NS_ConvertUTF16toUTF8(const nsAString&)
- NS_ConvertUTF16toUTF8(utf16String).get()
- CopyUTF8toUTF16(const nsACString& mLocalUTF8Value, nsAString& result))
`UTF-8` 拷贝覆盖 `UTF-16`
- CopyUTF16toUTF8(const nsAString&, nsACString&)

- AppendUTF8toUTF16(const nsACString&, nsAString&)
- AppendUTF16toUTF8(const nsAString&, nsACString&)
`UTF-8` 拷贝追加 `UTF-16`

- UTF8ToNewUnicode(const nsACString&, PRUint32* aUTF16Count = nsnull)
- ToNewUTF8String(const nsAString&)

### 有损转换
一般用于原始字符串为 `ASCII` 格式。
UTF-16 to ASCII converters
- NS_LossyConvertUTF16toASCII(nsAString)
- LossyCopyUTF16toASCII(nsAString, nsACString)
- LossyAppendUTF16toASCII(nsAString, nsACString)
- ToNewCString(nsAString)
ASCII to UTF-16 converters
- NS_ConvertASCIItoUTF16(nsACString)
- CopyASCIItoUTF16(nsACString, nsAString)
- AppendASCIItoUTF16(nsACString, nsAString)
- ToNewUnicode(nsACString)

## Literal Strings
原始字符串转换
- NS_LITERAL_CSTRING(literal string)
- NS_NAMED_LITERAL_CSTRING(variable, literal string)
- NS_LITERAL_STRING(literal string)
- NS_NAMED_LITERAL_STRING(variable,literal string) 

## Mozilla Framework Based on Templates

- `mfbt\ToString.h`
- `dist\include\mozilla\ToString.h`

https://firefox-source-docs.mozilla.org/xpcom/stringguide.html

所有的字符串类都是从 `nsAString/nsACString` 这两个抽象基类派生。

| 宽                 | 窄                  |
|-------------------|--------------------|
| nsAString         | nsACString         |
| nsString          | nsCString          |
| nsAutoString      | nsAutoCString      |
| nsDependentString | nsDependentCString |

- nsAString/nsACString: 所有字符串类的基类，定义了xpcom中字符串的基本操作，如赋值、字符存取、基本的字符操作，比较等。nsAString 可以不必是以null（\0）结尾的。（nsAString is not necessarily null-terminated.）
- nsString/nsCString: 从以上两个基类继承而来，可以保证字符串是以null结尾。这两个类允许通过get()方法获取c风格的字符串（以'\0'结尾的字符数组）。
```c++
nsString outFilePath;
outFilePath.Assign(basePath);
outFilePath.AppendLiteral("update.json");

ToString(outFilePath).c_str();
```
以为所有的字符串类都是从两个基类继承而来的，因为它们共享一些基本的API接口，如一些简单的只读函数：
.Length() - 字符串字符数目 (对于窄字符串类字符是char对于宽字节来说是PRUnichar)。
.IsEmpty() - 最快的可以判断字符串为空的方法. 用这个方法来代替 string.Length == 0
.Equals(string) - 判定两个字符串内容相同.

一些简单的改变字符串的方法：
.Assign(string) - 用string的值给字符串赋值.
.Append(string) - 追加string到字符串.
.Insert(string, position) - 在给定位置（position）的字符前插入string.
.Truncate(length) - 将字符串缩短到length指定的长度.

- char*
Raw character pointer to ASCII (7-bit) string, no string classes used.
- char16_t*
Raw character pointer to UTF-16 string, no string classes used.
- nsAString
UTF-16 string.
- nsACString
8-bit string
```c++
inline std::string ToString(const nsACString& text) {
  return {text.BeginReading(), text.Length()};
}

nsAutoString partitionKey;
partitionKey.AssignASCII(v.value().c_str());
NS_ConvertUTF16toUTF8(partitionKey);
```
- nsCString
```c++
nsCString(value.value().c_str())
```

- Append()

- AppendASCII()

- AppendLiteral()

- AppendPrintf()

- AppendFmt()

- AppendInt()

- AppendFloat()

- LossyAppendUTF16toASCII()

- AppendASCIItoUTF16()

- SetLength()

- Truncate()

- Assign()

- AssignLiteral()

- Adopt()

- CopyASCIItoUTF16()

- LossyCopyUTF16toASCII()

- AppendUTF16toUTF8()

- AppendUTF8toUTF16()

- CopyUTF16toUTF8()

- CopyUTF8toUTF16()


- NS_LossyConvertUTF16toASCII(nsAString) - a nsCAutoString which holds a temporary buffer containing the deflated value of the string.
- LossyCopyUTF16toASCII(nsAString, nsACString) - does an in-place conversion from UTF-16 into an ASCII string object.
- LossyAppendUTF16toASCII(nsAString, nsACString) - appends an UTF-16 string to an ASCII string, losing non-ASCII values.
- ToNewCString(nsAString) - allocates a new char* string.

- NS_ConvertASCIItoUTF16(nsACString) - a nsAutoString which holds a temporary buffer containing the inflated value of the string.
- CopyASCIItoUTF16(nsACString, nsAString) - does an in-place conversion from one string into a Unicode string object.
- AppendASCIItoUTF16(nsACString, nsAString) - appends an ASCII string to a Unicode string.
- ToNewUnicode(nsACString) - Creates a new PRUnichar* string which contains the inflated value.

- NS_LITERAL_CSTRING(literal string) - a temporary nsCString
- NS_NAMED_LITERAL_CSTRING(variable,literal string) - declares a nsCString variable named variable
- NS_LITERAL_STRING(literal string) - a temporary nsString with the unicode version of literal string
- NS_NAMED_LITERAL_STRING(variable,literal string) - declares a nsString variable named variable with the unicode version of literal string
```c++
// call Init(const PRUnichar*)
Init(L"start value"); // bad - L"..." is not portable!
Init(NS_ConvertASCIItoUTF16("start value").get()); // bad - runtime ASCII->UTF-16 conversion!
      
// call Init(const nsAString&)
Init(nsDependentString(L"start value")); // bad - not portable!
Init(NS_ConvertASCIItoUTF16("start value")); // bad - runtime ASCII->UTF-16 conversion!
      
// call Init(const nsACString&)
Init(nsDependentCString("start value")); // bad - length determined at runtime

// call Init(const PRUnichar*)
Init(NS_LITERAL_STRING("start value").get());

// call Init(const nsAString&)
Init(NS_LITERAL_STRING("start value"));

// call Init(const nsACString&)
Init(NS_LITERAL_CSTRING("start value"));

NS_NAMED_LITERAL_STRING(start, "start ");
NS_NAMED_LITERAL_STRING(middle, "middle ");
NS_NAMED_LITERAL_STRING(end, "end");
// create a string with 3 dependent fragments - no copying involved!
nsString combinedString = start + middle + end;

printf("%s\n", NS_LossyConvertUTF16toASCII(yourString).get());
printf("%s\n", NS_ConvertUTF16toUTF8(yourString).get());


```
