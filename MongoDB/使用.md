## Windows

```shell
net stop MongoDB
net start MongoDB
```

### é˜²ç«å¢™

```shell
New-NetFirewallRule `
    -DisplayName "MongoDB Server" `
    -Direction Inbound `
    -Protocol TCP `
    -LocalPort 27017 `
    -Action Allow `
    -Enabled True
```

## åˆ›å»ºç”¨æˆ·

```bash
use admin
db.createUser({
    user: "admin",
    pwd: passwordPrompt(),
    roles: ["root"]  // Grant root privileges (adjust based on your needs)
})
```

```bash
use amazon
db.createUser({
    user: "amazon",
    pwd: passwordPrompt(),
    roles: [{ role: "readWrite", db: "amazon" }]  // Grant root privileges (adjust based on your needs)
})
```

## ğŸ“‹ è§’è‰²åˆ†ç±»æ¦‚è§ˆ

MongoDB å†…ç½®è§’è‰²åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªå¤§ç±»ï¼š

### 1. **æ•°æ®åº“ç”¨æˆ·è§’è‰²**
### 2. **æ•°æ®åº“ç®¡ç†è§’è‰²**  
### 3. **é›†ç¾¤ç®¡ç†è§’è‰²**
### 4. **å¤‡ä»½å’Œæ¢å¤è§’è‰²**
### 5. **æ‰€æœ‰æ•°æ®åº“è§’è‰²**
### 6. **è¶…çº§ç”¨æˆ·è§’è‰²**
### 7. **è‡ªå®šä¹‰è§’è‰²**

## ğŸ—‚ï¸ ä¸€ã€æ•°æ®åº“ç”¨æˆ·è§’è‰²ï¼ˆDatabase User Rolesï¼‰

| è§’è‰²å | æƒé™æè¿° | é€‚ç”¨æ•°æ®åº“ |
|--------|----------|------------|
| **`read`** | è¯»å–æ‰€æœ‰éç³»ç»Ÿé›†åˆï¼Œä»¥åŠä»¥ä¸‹ç³»ç»Ÿé›†åˆï¼š`system.indexes`ã€`system.namespaces`ã€`system.js` | ä»»ä½•æ•°æ®åº“ |
| **`readWrite`** | åŒ…å« `read` æ‰€æœ‰æƒé™ï¼ŒåŠ ä¸Šï¼šå†™å…¥æ‰€æœ‰éç³»ç»Ÿé›†åˆï¼Œåˆ›å»º/åˆ é™¤é›†åˆï¼Œåˆ›å»ºç´¢å¼• | ä»»ä½•æ•°æ®åº“ |

## ğŸ› ï¸ äºŒã€æ•°æ®åº“ç®¡ç†è§’è‰²ï¼ˆDatabase Administration Rolesï¼‰

| è§’è‰²å | æƒé™æè¿° | é€‚ç”¨æ•°æ®åº“ |
|--------|----------|------------|
| **`dbAdmin`** | æ‰§è¡Œç®¡ç†ä»»åŠ¡ï¼šç´¢å¼•ç®¡ç†ã€æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ã€`compact`ã€`collMod`ã€`storageStats` | ä»»ä½•æ•°æ®åº“ |
| **`userAdmin`** | åˆ›å»ºå’Œä¿®æ”¹å½“å‰æ•°æ®åº“çš„ç”¨æˆ·å’Œè§’è‰²ï¼Œä½†ä¸èƒ½ç®¡ç†æ•°æ® | ä»»ä½•æ•°æ®åº“ |
| **`dbOwner`** | æ•°æ®åº“å®Œå…¨æ§åˆ¶æƒ = `readWrite` + `dbAdmin` + `userAdmin` | ä»»ä½•æ•°æ®åº“ |

## ğŸŒ ä¸‰ã€é›†ç¾¤ç®¡ç†è§’è‰²ï¼ˆCluster Administration Rolesï¼‰
**ï¼ˆåªèƒ½åœ¨ admin æ•°æ®åº“æˆäºˆï¼‰**

| è§’è‰²å | æƒé™æè¿° | é€‚ç”¨æ•°æ®åº“ |
|--------|----------|------------|
| **`clusterMonitor`** | åªè¯»ç›‘æ§æƒé™ï¼š`serverStatus`ã€`top`ã€`currentOp`ã€`listDatabases` | admin |
| **`hostManager`** | ç›‘æ§å’Œç®¡ç†æœåŠ¡å™¨ï¼š`killOp`ã€`setParameter`ã€`unsetParameter` | admin |
| **`clusterManager`** | ç®¡ç†å’Œç›‘æ§é›†ç¾¤ï¼š`addShard`ã€`flushRouterConfig`ã€`listShards`ã€`replSet*` | admin |
| **`clusterAdmin`** | é›†ç¾¤ç®¡ç†æœ€é«˜æƒé™ = `clusterManager` + `clusterMonitor` + `hostManager` + `dropDatabase` | admin |

## ğŸ’¾ å››ã€å¤‡ä»½å’Œæ¢å¤è§’è‰²ï¼ˆBackup and Restoration Rolesï¼‰
**ï¼ˆåªèƒ½åœ¨ admin æ•°æ®åº“æˆäºˆï¼‰**

| è§’è‰²å | æƒé™æè¿° | é€‚ç”¨æ•°æ®åº“ |
|--------|----------|------------|
| **`backup`** | å¤‡ä»½æ•°æ®æƒé™ï¼šè¯»å–æ‰€æœ‰æ•°æ®åº“ï¼Œ`listDatabases`ã€`listCollections` | admin |
| **`restore`** | æ¢å¤æ•°æ®æƒé™ï¼ˆé™¤äº† `system.profile` é›†åˆï¼‰ | admin |

## ğŸ”„ äº”ã€æ‰€æœ‰æ•°æ®åº“è§’è‰²ï¼ˆAll-Database Rolesï¼‰
**ï¼ˆåªèƒ½åœ¨ admin æ•°æ®åº“æˆäºˆï¼‰**

| è§’è‰²å | æƒé™æè¿° | é€‚ç”¨æ•°æ®åº“ |
|--------|----------|------------|
| **`readAnyDatabase`** | æ‰€æœ‰æ•°æ®åº“çš„åªè¯»æƒé™ï¼ˆé™¤ `local` å’Œ `config`ï¼‰ | admin |
| **`readWriteAnyDatabase`** | æ‰€æœ‰æ•°æ®åº“çš„è¯»å†™æƒé™ï¼ˆé™¤ `local` å’Œ `config`ï¼‰ | admin |
| **`userAdminAnyDatabase`** | æ‰€æœ‰æ•°æ®åº“çš„ç”¨æˆ·ç®¡ç†æƒé™ï¼ˆé™¤ `local` å’Œ `config`ï¼‰ | admin |
| **`dbAdminAnyDatabase`** | æ‰€æœ‰æ•°æ®åº“çš„ç®¡ç†æƒé™ï¼ˆé™¤ `local` å’Œ `config`ï¼‰ | admin |

## ğŸ‘‘ å…­ã€è¶…çº§ç”¨æˆ·è§’è‰²ï¼ˆSuperuser Rolesï¼‰

| è§’è‰²å | æƒé™æè¿° | é€‚ç”¨æ•°æ®åº“ |
|--------|----------|------------|
| **`root`** | è¶…çº§æƒé™ = `readWriteAnyDatabase` + `dbAdminAnyDatabase` + `userAdminAnyDatabase` + `clusterAdmin` + `restore` + `backup` | admin |

## ğŸ“Š ä¸ƒã€è§’è‰²æƒé™è¯¦ç»†å¯¹æ¯”è¡¨

```javascript
// æŸ¥è¯¢è§’è‰²çš„è¯¦ç»†æƒé™
db.runCommand({
  rolesInfo: "readWrite",
  showPrivileges: true
})
```

### æƒé™æ“ä½œå¯¹ç…§è¡¨

| æ“ä½œ/å‘½ä»¤ | read | readWrite | dbAdmin | userAdmin | clusterMonitor |
|-----------|------|-----------|---------|-----------|----------------|
| `find` | âœ… | âœ… | âŒ | âŒ | âŒ |
| `insert` | âŒ | âœ… | âŒ | âŒ | âŒ |
| `update` | âŒ | âœ… | âŒ | âŒ | âŒ |
| `delete` | âŒ | âœ… | âŒ | âŒ | âŒ |
| `createCollection` | âŒ | âœ… | âŒ | âŒ | âŒ |
| `createIndex` | âŒ | âœ… | âœ… | âŒ | âŒ |
| `dropCollection` | âŒ | âœ… | âŒ | âŒ | âŒ |
| `dropIndex` | âŒ | âœ… | âœ… | âŒ | âŒ |
| `createUser` | âŒ | âŒ | âŒ | âœ… | âŒ |
| `dropUser` | âŒ | âŒ | âŒ | âœ… | âŒ |
| `grantRole` | âŒ | âŒ | âŒ | âœ… | âŒ |
| `revokeRole` | âŒ | âŒ | âŒ | âœ… | âŒ |
| `serverStatus` | âŒ | âŒ | âŒ | âŒ | âœ… |
| `currentOp` | âŒ | âŒ | âŒ | âŒ | âœ… |
| `listDatabases` | âŒ | âŒ | âŒ | âŒ | âœ… |

## ğŸ”§ å…«ã€è‡ªå®šä¹‰è§’è‰²ï¼ˆCustom Rolesï¼‰

### åˆ›å»ºè‡ªå®šä¹‰è§’è‰²

```javascript
// åœ¨ admin æ•°æ®åº“åˆ›å»ºè‡ªå®šä¹‰è§’è‰²
use admin

db.createRole({
  role: "amazonAnalyst",
  privileges: [
    {
      resource: { db: "amazon", collection: "orders" },
      actions: ["find", "aggregate", "collStats", "indexStats"]
    },
    {
      resource: { db: "amazon", collection: "products" },
      actions: ["find"]
    },
    {
      resource: { db: "amazon", collection: "" },  // æ‰€æœ‰é›†åˆ
      actions: ["listCollections", "listIndexes"]
    }
  ],
  roles: []  // å¯ä»¥ç»§æ‰¿å…¶ä»–è§’è‰²
})

// åœ¨ç‰¹å®šæ•°æ®åº“åˆ›å»ºè§’è‰²
use reporting
db.createRole({
  role: "reportReader",
  privileges: [
    {
      resource: { db: "reporting", collection: "" },
      actions: ["find", "aggregate"]
    }
  ],
  roles: []
})
```

### å¯ç”¨æƒé™æ“ä½œåˆ—è¡¨ï¼ˆactionsï¼‰

```javascript
// æŸ¥è¯¢æƒé™
- find           // æŸ¥è¯¢æ–‡æ¡£
- collStats      // é›†åˆç»Ÿè®¡
- dbStats        // æ•°æ®åº“ç»Ÿè®¡
- indexStats     // ç´¢å¼•ç»Ÿè®¡
- listCollections // åˆ—å‡ºé›†åˆ
- listIndexes    // åˆ—å‡ºç´¢å¼•

// å†™æƒé™
- insert         // æ’å…¥æ–‡æ¡£
- update         // æ›´æ–°æ–‡æ¡£
- delete         // åˆ é™¤æ–‡æ¡£
- remove         // åˆ é™¤æ–‡æ¡£ï¼ˆåŒ deleteï¼‰
- createCollection // åˆ›å»ºé›†åˆ
- createIndex    // åˆ›å»ºç´¢å¼•
- dropCollection // åˆ é™¤é›†åˆ
- dropIndex      // åˆ é™¤ç´¢å¼•
- convertToCapped // è½¬æ¢ä¸ºå›ºå®šé›†åˆ
- emptycapped    // æ¸…ç©ºå›ºå®šé›†åˆ

// ç®¡ç†æƒé™
- changeCustomData   // ä¿®æ”¹ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®
- changePassword    // ä¿®æ”¹å¯†ç 
- createRole        // åˆ›å»ºè§’è‰²
- createUser        // åˆ›å»ºç”¨æˆ·
- dropRole          // åˆ é™¤è§’è‰²
- dropUser          // åˆ é™¤ç”¨æˆ·
- grantRole         // æˆäºˆè§’è‰²
- revokeRole        // æ’¤é”€è§’è‰²
- setAuthenticationRestriction // è®¾ç½®è®¤è¯é™åˆ¶
- viewRole          // æŸ¥çœ‹è§’è‰²
- viewUser          // æŸ¥çœ‹ç”¨æˆ·

// æ•°æ®åº“ç®¡ç†æƒé™
- bypassDocumentValidation  // ç»•è¿‡æ–‡æ¡£éªŒè¯
- enableProfiler     // å¯ç”¨åˆ†æå™¨
- killCursors        // ç»ˆæ­¢æ¸¸æ ‡
- killop             // ç»ˆæ­¢æ“ä½œ
- modifyOplogLevel   // ä¿®æ”¹æ“ä½œæ—¥å¿—çº§åˆ«
- planCacheRead      // è¯»å–æŸ¥è¯¢è®¡åˆ’ç¼“å­˜
- planCacheWrite     // å†™å…¥æŸ¥è¯¢è®¡åˆ’ç¼“å­˜
- storageDetails     // å­˜å‚¨è¯¦æƒ…

// é›†ç¾¤ç®¡ç†æƒé™
- addShard           // æ·»åŠ åˆ†ç‰‡
- appendOplogNote    // è¿½åŠ æ“ä½œæ—¥å¿—æ³¨é‡Š
- applicationMessage // åº”ç”¨æ¶ˆæ¯
- authenticate       // è®¤è¯
- cleanupOrphaned    // æ¸…ç†å­¤å„¿æ–‡æ¡£
- flushRouterConfig  // åˆ·æ–°è·¯ç”±å™¨é…ç½®
- fsync              // åŒæ­¥åˆ°ç£ç›˜
- getParameter       // è·å–å‚æ•°
- hostInfo           // ä¸»æœºä¿¡æ¯
- logRotate          // æ—¥å¿—è½®è½¬
- moveChunk          // ç§»åŠ¨åˆ†ç‰‡å—
- removeShard        // ç§»é™¤åˆ†ç‰‡
- replSetConfigure   // é…ç½®å‰¯æœ¬é›†
- replSetGetConfig   // è·å–å‰¯æœ¬é›†é…ç½®
- replSetGetStatus   // è·å–å‰¯æœ¬é›†çŠ¶æ€
- replSetHeartbeat   // å‰¯æœ¬é›†å¿ƒè·³
- replSetStateChange // å‰¯æœ¬é›†çŠ¶æ€å˜æ›´
- resync             // é‡æ–°åŒæ­¥
- setParameter       // è®¾ç½®å‚æ•°
- shutdown           // å…³é—­
- touch              // æ¥è§¦æ•°æ®
- unlock             // è§£é”
```

## ğŸ¯ ä¹ã€è§’è‰²ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šåˆ›å»ºç”µå•†ç³»ç»Ÿç”¨æˆ·

```javascript
use admin

// åˆ›å»ºåªè¯»æŠ¥è¡¨ç”¨æˆ·
db.createUser({
  user: "report_user",
  pwd: "Report@2024",
  roles: [
    { role: "read", db: "amazon" },
    { role: "read", db: "amazon_analytics" },
    { role: "clusterMonitor", db: "admin" }  // æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
  ]
})

// åˆ›å»ºåº”ç”¨ç”¨æˆ·
db.createUser({
  user: "app_user",
  pwd: "App@Secure123",
  roles: [
    { role: "readWrite", db: "amazon" },
    { role: "read", db: "amazon_logs" },
    { role: "dbAdmin", db: "amazon" }  // å¯ä»¥ç®¡ç†ç´¢å¼•
  ]
})

// åˆ›å»ºç®¡ç†ç”¨æˆ·
db.createUser({
  user: "amazon_dba",
  pwd: "Dba@Master456",
  roles: [
    { role: "dbOwner", db: "amazon" },
    { role: "dbAdmin", db: "amazon_logs" },
    { role: "backup", db: "admin" }  // å¯ä»¥å¤‡ä»½
  ]
})
```

### ç¤ºä¾‹2ï¼šåˆ›å»ºè‡ªå®šä¹‰ç›‘æ§è§’è‰²

```javascript
use admin

db.createRole({
  role: "customMonitor",
  privileges: [
    // ç›‘æ§æ‰€æœ‰æ•°æ®åº“
    {
      resource: { cluster: true },
      actions: [
        "serverStatus",
        "top",
        "currentOp",
        "connPoolStats",
        "getCmdLineOpts",
        "getLog",
        "getParameter",
        "hostInfo",
        "inprog",
        "listDatabases",
        "listSessions",
        "netstat"
      ]
    },
    // è¯»å–é…ç½®æ•°æ®åº“
    {
      resource: { db: "config", collection: "" },
      actions: ["find", "listCollections"]
    }
  ],
  roles: []
})
```

## ğŸ“ åã€æŸ¥çœ‹å’Œç®¡ç†è§’è‰²

### æŸ¥çœ‹ç°æœ‰è§’è‰²

```javascript
// æŸ¥çœ‹æ‰€æœ‰å†…ç½®è§’è‰²
db.getRoles({showBuiltinRoles: true})

// æŸ¥çœ‹ç‰¹å®šè§’è‰²è¯¦æƒ…
db.getRole("readWrite", {showPrivileges: true})

// æŸ¥çœ‹ç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²
db.getUser("username")

// æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·å’Œè§’è‰²
db.system.users.find().pretty()
db.system.roles.find().pretty()
```

### ä¿®æ”¹è§’è‰²

```javascript
// æ›´æ–°è§’è‰²æƒé™
db.updateRole("customRole", {
  privileges: [
    {
      resource: { db: "mydb", collection: "" },
      actions: ["find", "insert", "update"]
    }
  ],
  roles: []
})

// ç»™è§’è‰²æ·»åŠ æƒé™
db.grantPrivilegesToRole("customRole", [
  {
    resource: { db: "mydb", collection: "logs" },
    actions: ["find"]
  }
])

// ä»è§’è‰²æ’¤é”€æƒé™
db.revokePrivilegesFromRole("customRole", [
  {
    resource: { db: "mydb", collection: "logs" },
    actions: ["find"]
  }
])
```

## ğŸš€ åä¸€ã€ç‰¹æ®Šå’Œè¿‡æ—¶è§’è‰²

### ç‰¹æ®Šè§’è‰²

| è§’è‰²å | æè¿° | çŠ¶æ€ |
|--------|------|------|
| **`__system`** | MongoDB å†…éƒ¨ä½¿ç”¨ï¼Œè¶…çº§æƒé™ | å†…éƒ¨ä½¿ç”¨ï¼Œä¸è¦æˆäºˆç”¨æˆ· |
| **`__queryableBackup`** | å¯æŸ¥è¯¢å¤‡ä»½è§’è‰² | ç‰¹å®šåœºæ™¯ä½¿ç”¨ |

### å·²å¼ƒç”¨è§’è‰²ï¼ˆMongoDB 4.0+ï¼‰

| è§’è‰²å | æ›¿ä»£æ–¹æ¡ˆ | å¼ƒç”¨åŸå›  |
|--------|----------|----------|
| `dbMaster` | `dbOwner` | åç§°å˜æ›´ |
| `userAdminAnyDatabase` | ä»å¯ç”¨ | - |
| `readAnyDatabase` | ä»å¯ç”¨ | - |

## ğŸ’¡ åäºŒã€æœ€ä½³å®è·µ

### 1. **æŒ‰éœ€åˆ†é…åŸåˆ™**
```javascript
// ä¸å¥½ï¼šæƒé™è¿‡å¤§
roles: [{ role: "root", db: "admin" }]

// å¥½ï¼šç²¾ç¡®æˆæƒ
roles: [
  { role: "readWrite", db: "app_data" },
  { role: "read", db: "app_logs" },
  { role: "dbAdmin", db: "app_data" }
]
```

### 2. **è§’è‰²ç»§æ‰¿**
```javascript
// åˆ›å»ºåŸºç¡€è§’è‰²
db.createRole({
  role: "baseAppUser",
  privileges: [...],
  roles: []
})

// å…¶ä»–è§’è‰²ç»§æ‰¿
db.createRole({
  role: "advancedAppUser",
  privileges: [...],
  roles: [{ role: "baseAppUser", db: "admin" }]
})
```

### 3. **å®šæœŸå®¡è®¡**
```javascript
// æ¯æœˆæ£€æŸ¥ä¸€æ¬¡è§’è‰²åˆ†é…
db.system.users.find().forEach(function(user) {
  print("User: " + user.user);
  print("Roles: " + JSON.stringify(user.roles));
  print("---");
});
```

## ğŸ“Š åä¸‰ã€è§’è‰²é€‰æ‹©å†³ç­–æ ‘

```
éœ€è¦ä»€ä¹ˆæƒé™ï¼Ÿ
â”œâ”€â”€ åªè¯»æ•°æ® â†’ read
â”œâ”€â”€ è¯»å†™æ•°æ® â†’ readWrite
â”œâ”€â”€ ç®¡ç†æ•°æ®åº“ç»“æ„ â†’ dbAdmin
â”œâ”€â”€ ç®¡ç†ç”¨æˆ· â†’ userAdmin
â”œâ”€â”€ å…¨éƒ¨æ•°æ®åº“æƒé™ â†’ 
â”‚   â”œâ”€â”€ åªè¯» â†’ readAnyDatabase
â”‚   â”œâ”€â”€ è¯»å†™ â†’ readWriteAnyDatabase
â”‚   â””â”€â”€ ç®¡ç† â†’ dbAdminAnyDatabase
â”œâ”€â”€ é›†ç¾¤ç®¡ç† â†’ clusterAdmin / clusterMonitor
â”œâ”€â”€ å¤‡ä»½æ¢å¤ â†’ backup / restore
â””â”€â”€ è¶…çº§æƒé™ â†’ root
```

## ğŸ¯ åå››ã€å¸¸ç”¨è§’è‰²ç»„åˆ

```javascript
// 1. åº”ç”¨æœåŠ¡å™¨ç”¨æˆ·
roles: [
  { role: "readWrite", db: "app_db" },
  { role: "read", db: "app_logs" }
]

// 2. æŠ¥è¡¨ç”¨æˆ·
roles: [
  { role: "read", db: "app_db" },
  { role: "read", db: "reporting" },
  { role: "clusterMonitor", db: "admin" }
]

// 3. DBA ç”¨æˆ·
roles: [
  { role: "dbOwner", db: "production" },
  { role: "backup", db: "admin" },
  { role: "clusterMonitor", db: "admin" }
]

// 4. åªè¯»ç›‘æ§ç”¨æˆ·
roles: [
  { role: "readAnyDatabase", db: "admin" },
  { role: "clusterMonitor", db: "admin" }
]
```

## ğŸ”— å‚è€ƒèµ„æ–™

```javascript
// æŸ¥çœ‹ MongoDB å®˜æ–¹æ–‡æ¡£
// æ‰€æœ‰å†…ç½®è§’è‰²ï¼šhttps://docs.mongodb.com/manual/reference/built-in-roles/

// æŸ¥çœ‹å½“å‰æ•°æ®åº“æ‰€æœ‰å¯æ‰§è¡Œæ“ä½œ
db.runCommand({ listCommands: 1 })

// æŸ¥çœ‹è§’è‰²æ”¯æŒçš„æ‰€æœ‰æƒé™
db.runCommand({ rolesInfo: 1, showPrivileges: true })
```

è®°ä½ï¼š**è§’è‰²æ˜¯æƒé™çš„é›†åˆ**ï¼Œæ­£ç¡®åˆ†é…è§’è‰²å¯ä»¥ç¡®ä¿ç³»ç»Ÿå®‰å…¨æ€§å’Œç”¨æˆ·å·¥ä½œæ•ˆç‡ã€‚
