
### **完善版 Python 打包实战教程：从代码到可执行文件**

Python 因其易学易用而广受欢迎，但分发代码时要求用户安装解释器和依赖库，极为不便。将 Python 脚本打包成独立的可执行文件（exe/app），是交付给最终用户最友好的方式。本文将详细介绍 6 种主流打包方案，并帮助你根据场景做出最佳选择。

#### **核心打包工具对比与选择建议**

| 工具 | 核心优势 | 主要平台 | 打包结果 | 推荐场景 |
| :--- | :--- | :--- | :--- | :--- |
| **PyInstaller** | 简单易用，生态最广 | Win, Linux, Mac | 文件夹或单文件 | **绝大多数项目的首选**，尤其适合图形界面和复杂应用 |
| **cx_Freeze** | 官方维护，相对稳定 | Win, Linux, Mac | 文件夹 | 基础打包需求，作为 PyInstaller 的备选 |
| **Nuitka** | 将Python编译为C，性能高，逆向困难 | Win, Linux, Mac | 文件夹 | 对性能、代码保护有较高要求的项目 |
| **py2exe** | 历史悠久 | **仅 Windows** | 文件夹 | 仅需支持旧版Windows的遗留项目 |
| **py2app** | 针对 macOS 优化 | **仅 macOS** | App 包 | 专门为 macOS 分发应用 |
| **Nuitka + PyInstaller**| 结合编译与打包优势 | Win, Linux, Mac | 文件夹或单文件 | 追求极致性能与打包一体化的高级需求 |

---

#### **一、 PyInstaller（首选推荐）**

PyInstaller 是目前最流行、支持最好的打包工具。

**1. 基本安装与使用**
```bash
pip install pyinstaller
# 打包成文件夹（便于调试，启动稍快）
pyinstaller your_script.py
# 打包成单个exe文件（分发方便）
pyinstaller -F your_script.py
# 打包时清理临时文件
pyinstaller -F -c your_script.py
```

**2. 进阶配置：规范文件（Spec File）**
对于复杂项目，使用 spec 文件进行配置更佳。
```bash
# 首先生成 spec 文件
pyinstaller --name MyApp your_script.py
```
编辑生成的 `MyApp.spec` 文件，可以：
*   **添加数据文件（如图片、配置文件）**：
    ```python
    a = Analysis(
        ...
        datas=[('src/assets/*.png', 'assets'), ('config.ini', '.')],
        ...
    )
    ```
*   **隐藏控制台窗口（适用于 GUI 程序）**：
    ```python
    exe = EXE(
        ...
        console=False,  # 改为 True 则显示控制台
        icon='app_icon.ico' # 设置图标
    )
    ```
然后使用 spec 文件打包：
```bash
pyinstaller MyApp.spec
```

**3. 常见问题与解决**
*   **文件过大**：使用 `--clean` 清除缓存，或考虑使用 `Nuitka` 编译。
*   **“Failed to execute script”**：通常是打包时漏掉了隐式导入的模块。在 spec 文件中用 `hiddenimports` 添加。
    ```python
    a = Analysis(
        ...
        hiddenimports=['pandas', 'numpy.core._methods'],
        ...
    )
    ```

---

#### **二、 cx_Freeze**

作为备选方案，cx_Freeze 配置直观，适合简单脚本。

**1. 安装与基础使用**
```bash
pip install cx-freeze
```
创建 `setup.py` 配置文件：
```python
from cx_Freeze import setup, Executable

setup(
    name="MyApp",
    version="1.0",
    description="My Application",
    executables=[Executable("your_script.py", base="Win32GUI")], # base用于隐藏控制台
    options={
        "build_exe": {
            "packages": ["os"], # 明确包含的包
            "excludes": ["tkinter"], # 排除的包以减小体积
            "include_files": ["data/", "config.ini"] # 包含数据文件
        }
    }
)
```
运行打包命令：
```bash
python setup.py build
```

---

#### **三、 Nuitka（追求性能与保护）**

Nuitka 将 Python 编译为 C/C++，能提升运行速度并增加反编译难度。

**1. 基本安装与使用**
```bash
pip install nuitka
# 基本编译，生成一个可执行文件和大量依赖文件
python -m nuitka your_script.py
# 打包成独立文件夹（推荐）
python -m nuitka --standalone your_script.py
# 启用所有优化，并禁用控制台（适合GUI）
python -m nuitka --standalone --enable-plugin=pyqt5 --windows-disable-console your_script.py
```

**2. 与 PyInstaller 结合使用**
一种常见模式是先由 Nuitka 编译，再用 PyInstaller 打包成单文件。
```bash
# 步骤1: 使用 Nuitka 编译为独立文件夹
python -m nuitka --standalone your_script.py

# 步骤2: 进入生成的 `your_script.dist` 目录，将其中的可执行文件和依赖库一起用 PyInstaller 打包
# 但更常见的做法是直接使用 Nuitka 的 `--onefile` 选项（实验性）
python -m nuitka --standalone --onefile your_script.py
```
> **注意**：Nuitka 的 `--onefile` 选项尚处于实验阶段，稳定性可能不如 PyInstaller。

---

#### **四、 平台专用工具**

*   **py2exe**: 仅适用于 Windows，目前维护不活跃，**仅建议用于旧项目维护**。
    ```python
    # setup.py
    from distutils.core import setup
    import py2exe
    setup(console=['your_script.py'])
    ```

*   **py2app**: 为 macOS 生成原生 `.app` 捆绑包。
    ```bash
    pip install py2app
    # 生成配置
    py2applet --make-setup MyApp.py
    # 打包为开发模式（链接到本地文件，便于测试）
    python setup.py py2app -A
    # 打包为发布模式
    python setup.py py2app
    ```

---

#### **打包通用最佳实践**

1.  **虚拟环境**：始终在干净的虚拟环境中安装依赖并打包，避免带入无关库。
    ```bash
    python -m venv pack_env
    source pack_env/bin/activate  # Linux/Mac
    pack_env\Scripts\activate     # Windows
    pip install -r requirements.txt pyinstaller
    ```
2.  **路径处理**：打包后程序的工作路径会变。使用以下代码安全地获取资源路径：
    ```python
    import sys
    import os

    if getattr(sys, 'frozen', False):
        base_path = sys._MEIPASS  # PyInstaller 创建的临时目录
    else:
        base_path = os.path.abspath(".")

    config_path = os.path.join(base_path, "config.ini")
    ```
3.  **分阶段测试**：先打包成文件夹（`-D`）进行测试，确保所有资源都被正确包含，再尝试打包为单文件（`-F`）。

#### **总结**

对于大多数开发者，推荐路径如下：
*   **新手与快速交付**：直接使用 **PyInstaller** (`-F` 或 `-D` 选项)。
*   **性能敏感或代码保护**：使用 **Nuitka** (`--standalone`)。
*   **为 macOS 分发应用**：使用 **py2app**。
*   **遗留 Windows 项目维护**：使用 **py2exe**。
