## 安装

Consul: 在所有 Ubuntu 服务器上下载并安装 Consul.

```bash
sudo apt update && sudo apt install gpg

wget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
sudo apt update && sudo apt install consul
```

## 配置文件说明

- /etc/consul.d/consul.env
这个文件通常用于设置 Consul 运行时的环境变量。环境变量可以影响 Consul 的行为，例如设置日志级别、数据目录路径等。在这个文件中，你可以配置一些 Consul 运行时所需的环境变量。

- /etc/consul.d/consul.hcl
这是 Consul 的主要配置文件。在这个文件中，你可以配置 Consul 的各种选项，包括集群配置、数据中心、节点名称、绑定地址、广告地址、加入集群的地址、监听端口、日志设置等。通过编辑这个文件，你可以定制 Consul 的行为和功能。

- /usr/bin/consul
这是 Consul 的可执行文件。通过执行这个文件，你可以启动 Consul Agent，并根据配置文件中的设置来运行 Consul。

- /usr/lib/systemd/system/consul.service
这是 Consul 的 Systemd 服务单元文件。它定义了 Consul 作为 Systemd 服务的配置，包括服务的启动方式、依赖关系等。通过 Systemd，你可以使用 systemctl 命令来管理 Consul 服务的启动、停止、重启等操作。

## 生成 Gossip 加密 Key

运行 consul keygen 生成一个密钥，并在所有 Agent 的配置文件中设置 encrypt.

```bash
consul keygen
```

## IP

- 10.0.0.222
- 10.0.0.200
- 10.0.0.115

## 统一所有节点的 datacenter 名称

`datacenter = "serp-config-dc"`

## 开启UI

```conf
ui_config{                                                                                                                                                                                                                                                                           
  enabled = true
}
```

```conf
# Consul 配置文件

# 数据中心设置
datacenter = "serp-config-dc"

# 节点名称设置（注意：不可重名，默认使用主机名）
node_name = "consul-36"

# 数据目录设置
data_dir = "/opt/consul"

# 日志级别设置（可选值：TRACE, DEBUG, INFO, WARN, ERR）
log_level = "ERR"

# 绑定地址设置（监听所有 IPv6 地址和所有 IPv4 地址）
bind_addr = "[::]"
bind_addr = "0.0.0.0"

# 广播自己地址给集群访问（用于集群内部通信）
advertise_addr = "10.0.0.222"

# 加入集群的地址列表（需要提供至少一个已知的集群节点地址,:8301默认端口可省略）
retry_join = ["10.0.0.200", "10.0.0.115"]
# 用于指定 Consul Agent 在启动时尝试通过加入集群节点。
start_join = ["10.0.0.200", "10.0.0.115"]

# 服务节点设置（是否为服务器节点）
server = true
# 这会告诉Consul在引导期间等待2个服务器节点就绪，然后再引导整个集群。
bootstrap_expect = 2

# 加密设置（consul keygen 生成的用于集群网络通信的加密）
encrypt = "KUZZ6X4oQhUvXeu+aN1EHL4DVgep8jk4ltflcLQ2DvQ="

# 客户端地址设置（用于监听客户端请求的地址）
client_addr = "0.0.0.0"

# UI 配置（用于启用内置的 Web UI）
ui_config {
  enabled = true
  content_path = "/ui/" #可自定义路径
}

# 默认端口设置
ports {
  # HTTP API 端口（默认值：8500）与 Consul 进行交互，包括服务注册、UI、健康检查等
  http = 8500
  # DNS 端口（默认值：8600）用于提供 DNS 查询服务，允许客户端通过 DNS 协议来查询服务实例的地址
  dns = 8600
  # Serf LAN 端口（默认值：8301）局域网内进行集群节点间的通信
  serf_lan = 8301
  # Serf WAN 端口（默认值：8302） 广域网（WAN）内进行集群节点间的通信，用于跨数据中心的通信
  serf_wan = 8302
  # 服务器 RPC 端口（默认值：8300）服务器节点之间进行 RPC 通信
  server = 8300
}
```

## 检查节点状态

```bash
# 查看当前节点类型
consul info | grep -E "(server|bootstrap_expect)"

# 查看集群成员
consul members

# 查看节点详细信息
consul catalog nodes -detailed
```

## 访问界面

http://43.159.143.42:8500/ui/serp-config-dc/acls/tokens

## 设置 ACL 使用 SecretID 登录 ui

### 1. 修改配置启用ACL

```bash
# 编辑Consul配置文件
sudo nano /etc/consul.d/acl.hcl
```

添加以下内容：
```hcl
# ACL配置
acl = {
  enabled = true
  default_policy = "deny"  # 默认拒绝所有访问
  enable_token_persistence = true
  down_policy = "extend-cache"
  
  # 令牌配置（初始化后填写）
  tokens = {
    # 初始为空
  }
}
```

或者添加到主配置文件：
```hcl
# /etc/consul.d/consul.hcl
acl {
  enabled = true
  default_policy = "deny"
  enable_token_persistence = true
  tokens {
    # 代理令牌将在引导后配置
  }
}
```

### 重启Consul服务并引导ACL

```bash
# 重启Consul服务
sudo systemctl restart consul

# 等待服务启动
sleep 5

# 引导ACL系统（仅在第一个服务器节点执行）
consul acl bootstrap

# 输出示例：
# AccessorID:       6a1253d2-a828-4a3e-9e0e-7e1572e2d6c1
# SecretID:         b1b6a970-1aac-4c1d-83e6-6a1a4b5e5c2d
# Description:      Bootstrap Token (Global Management)
# Local:            false
# Create Time:      2024-01-15 12:00:00 +0000 UTC
# Policies:
#    00000000-0000-0000-0000-000000000001 - global-management
```

**重要：保存输出的SecretID！**

### 3. 设置环境变量使用令牌

```bash
# 设置环境变量（推荐）
export CONSUL_HTTP_TOKEN="b1b6a970-1aac-4c1d-83e6-6a1a4b5e5c2d"

# 或者创建令牌文件
echo "b1b6a970-1aac-4c1d-83e6-6a1a4b5e5c2d" > ~/consul_token
export CONSUL_HTTP_TOKEN_FILE="~/consul_token"

# 验证令牌
consul acl token read -self
```

## 二、创建和管理策略（Policies）

### 1. 创建策略文件目录

```bash
# 创建策略目录
sudo mkdir -p /etc/consul.d/policies/
```

### 2. 常用策略示例

#### 策略1：只读访问策略
```hcl
# /etc/consul.d/policies/read-only.hcl
node_prefix "" {
  policy = "read"
}

service_prefix "" {
  policy = "read"
}

key_prefix "" {
  policy = "read"
}

event_prefix "" {
  policy = "read"
}

query_prefix "" {
  policy = "read"
}
```

#### 策略2：服务管理策略
```hcl
# /etc/consul.d/policies/service-web.hcl
service "web" {
  policy = "write"
}

service_prefix "" {
  policy = "read"
}

node_prefix "" {
  policy = "read"
}

key_prefix "web/" {
  policy = "write"
}

session_prefix "" {
  policy = "read"
}
```

#### 策略3：KV存储管理策略
```hcl
# /etc/consul.d/policies/kv-admin.hcl
key_prefix "" {
  policy = "write"
}

node_prefix "" {
  policy = "read"
}

agent_prefix "" {
  policy = "read"
}

operator = "read"
```

#### 策略4：API网关策略
```hcl
# /etc/consul.d/policies/api-gateway.hcl
service_prefix "" {
  policy = "read"
}

key_prefix "routes/" {
  policy = "write"
}

node_prefix "" {
  policy = "read"
}

query_prefix "api-" {
  policy = "write"
}
```

#### 策略5：Consul代理策略
```hcl
# /etc/consul.d/policies/agent-policy.hcl
agent_prefix "" {
  policy = "write"
}

node_prefix "" {
  policy = "write"
}

service_prefix "" {
  policy = "read"
}

key_prefix "" {
  policy = "read"
}
```

### 3. 创建策略

```bash
# 创建只读策略
consul acl policy create \
  -name "read-only" \
  -description "Read-only access to all resources" \
  -rules @/etc/consul.d/policies/read-only.hcl

# 创建Web服务策略
consul acl policy create \
  -name "web-service" \
  -description "Full access to web service and related KV" \
  -rules @/etc/consul.d/policies/service-web.hcl

# 查看所有策略
consul acl policy list

# 查看策略详情
consul acl policy read -name "read-only"
```

### 4. 特殊内置策略

```bash
# 查看内置策略
consul acl policy list | grep -E "(global-management|anonymous)"

# global-management: 超级管理员策略
# anonymous: 匿名访问策略（当没有提供令牌时使用）
```

## 三、创建和管理令牌（Tokens）

### 1. 创建令牌

```bash
# 1. 创建带有管理权限的令牌
consul acl token create \
  -description "Admin Token" \
  -policy-name "global-management"

# 2. 创建带有多个策略的令牌
consul acl token create \
  -description "Web Service Admin Token" \
  -policy-name "web-service" \
  -policy-name "read-only"

# 3. 创建服务令牌（用于服务注册）
consul acl token create \
  -description "Web Service Registration Token" \
  -policy-name "web-service" \
  -local  # 仅在本数据中心有效

# 4. 创建带过期时间的令牌
consul acl token create \
  -description "Temporary Access Token" \
  -policy-name "read-only" \
  -ttl "24h"

# 5. 通过JSON创建令牌
cat > /tmp/token-web.json << EOF
{
  "Description": "Web Service Token via JSON",
  "Policies": [
    {
      "Name": "web-service"
    }
  ],
  "Local": false
}
EOF

consul acl token create -json @/tmp/token-web.json
```

### 2. 令牌管理命令

```bash
# 列出所有令牌
consul acl token list

# 查看令牌详情
consul acl token read -id <token-id>
consul acl token read -accessor-id <accessor-id>
consul acl token read -self  # 查看当前令牌

# 更新令牌
consul acl token update \
  -id <token-id> \
  -description "Updated description" \
  -policy-name "new-policy"

# 禁用令牌（设置过期）
consul acl token update \
  -id <token-id> \
  -expiration-ttl "1h"

# 删除令牌
consul acl token delete -id <token-id>

# 克隆令牌
consul acl token clone \
  -id <token-id> \
  -description "Cloned token for backup"

# 查看令牌关联的策略
consul acl token read -id <token-id> | jq '.Policies'
```

### 3. 批量创建令牌脚本

```bash
#!/bin/bash
# create-service-tokens.sh

SERVICES=("web" "api" "payment" "user" "notification")

for SERVICE in "${SERVICES[@]}"; do
    echo "为服务 $SERVICE 创建令牌..."
    
    # 创建策略文件
    cat > /tmp/${SERVICE}-policy.hcl << EOF
service "${SERVICE}" {
  policy = "write"
}

service_prefix "" {
  policy = "read"
}

key_prefix "${SERVICE}/" {
  policy = "write"
}

node_prefix "" {
  policy = "read"
}
EOF
    
    # 创建策略
    consul acl policy create \
      -name "${SERVICE}-policy" \
      -description "Policy for ${SERVICE} service" \
      -rules @/tmp/${SERVICE}-policy.hcl
    
    # 创建令牌
    TOKEN_INFO=$(consul acl token create \
      -description "${SERVICE} Service Token" \
      -policy-name "${SERVICE}-policy" \
      -format json)
    
    SECRET_ID=$(echo $TOKEN_INFO | jq -r '.SecretID')
    ACCESSOR_ID=$(echo $TOKEN_INFO | jq -r '.AccessorID')
    
    echo "服务: $SERVICE"
    echo "  SecretID: $SECRET_ID"
    echo "  AccessorID: $ACCESSOR_ID"
    echo "  Token: $SECRET_ID" | sudo tee /etc/consul/tokens/${SERVICE}.token
    echo ""
done
```

## 四、配置代理令牌（Agent Tokens）

### 1. 创建代理策略和令牌

```bash
# 创建代理策略
cat > /etc/consul.d/policies/agent-policy.hcl << EOF
agent_prefix "" {
  policy = "write"
}

node_prefix "" {
  policy = "write"
}

service_prefix "" {
  policy = "read"
}

key_prefix "" {
  policy = "read"
}

event_prefix "" {
  policy = "write"
}
EOF

consul acl policy create \
  -name "agent-policy" \
  -description "Policy for Consul agents" \
  -rules @/etc/consul.d/policies/agent-policy.hcl

# 创建代理令牌
AGENT_TOKEN=$(consul acl token create \
  -description "Agent Token for all nodes" \
  -policy-name "agent-policy" \
  -format json | jq -r '.SecretID')

echo "代理令牌: $AGENT_TOKEN"
```

### 2. 更新Consul配置使用代理令牌

```bash
# 编辑Consul配置
sudo nano /etc/consul.d/tokens.hcl
```

添加：
```hcl
acl {
  enabled = true
  default_policy = "deny"
  enable_token_persistence = true
  
  tokens {
    # 默认令牌（用于未提供令牌的请求）
    default = "00000000-0000-0000-0000-000000000002"  # 匿名令牌ID
    
    # 代理令牌（用于内部操作）
    agent = "b1b6a970-1aac-4c1d-83e6-6a1a4b5e5c2d"  # 替换为您的代理令牌
    
    # 用于加密消息的令牌
    agent_master = "b1b6a970-1aac-4c1d-83e6-6a1a4b5e5c2d"
    
    # 用于复制操作的令牌
    replication = "b1b6a970-1aac-4c1d-83e6-6a1a4b5e5c2d"
  }
}
```

### 3. 为不同用途配置多个令牌

```hcl
tokens {
  # 默认令牌（当请求没有提供令牌时使用）
  default = "anonymous-token-id"
  
  # 代理令牌
  agent = "agent-token-id"
  
  # 用于内部通信的令牌
  agent_master = "agent-master-token-id"
  
  # 用于复制的令牌
  replication = "replication-token-id"
  
  # 用于加密的令牌
  encrypt = "encrypt-token-id"
  
  # DNS接口令牌
  dns = "dns-token-id"
}
```

## 五、服务注册与ACL

### 1. 服务定义文件包含令牌

```json
{
  "service": {
    "name": "web",
    "port": 80,
    "tags": ["nginx", "v1"],
    "token": "web-service-token-id",
    "meta": {
      "version": "1.0",
      "environment": "production"
    },
    "check": {
      "http": "http://localhost:80/health",
      "interval": "10s",
      "timeout": "2s",
      "token": "web-service-token-id"
    },
    "connect": {
      "sidecar_service": {}
    }
  }
}
```

### 2. 通过环境变量指定服务令牌

```bash
# 设置服务令牌环境变量
export CONSUL_SERVICE_TOKEN="web-service-token-id"

# 注册服务
consul services register /etc/consul.d/service-web.json
```

### 3. 通过API注册服务（使用令牌）

```bash
# 使用HTTP头传递令牌
curl -X PUT \
  -H "X-Consul-Token: web-service-token-id" \
  -H "Content-Type: application/json" \
  -d '{
    "Name": "web",
    "Port": 80,
    "Tags": ["nginx"],
    "Check": {
      "HTTP": "http://localhost:80/health",
      "Interval": "10s"
    }
  }' \
  http://localhost:8500/v1/agent/service/register
```

## 六、ACL与KV存储

### 1. KV存储ACL规则示例

```hcl
# KV存储策略
key_prefix "" {
  policy = "deny"  # 默认拒绝所有
}

key_prefix "config/" {
  policy = "read"
}

key_prefix "config/web/" {
  policy = "write"
}

key_prefix "secrets/" {
  policy = "deny"
}

key_prefix "public/" {
  policy = "read"
}

# 特定键的规则
key "admin/api_key" {
  policy = "deny"
}

key "app/database_url" {
  policy = "write"
}
```

### 2. KV操作示例（带ACL）

```bash
# 写入KV（需要写权限）
consul kv put -token="web-token" config/web/hostname "web01.example.com"

# 读取KV（需要读权限）
consul kv get -token="web-token" config/web/hostname

# 递归列出（需要对应前缀的读权限）
consul kv get -recurse -token="web-token" config/

# 删除KV（需要写权限）
consul kv delete -token="web-token" config/web/hostname
```

## 七、ACL与DNS接口

### 1. 配置DNS令牌

```hcl
# 在Consul配置中
acl {
  tokens {
    dns = "dns-read-token-id"
  }
}
```

### 2. DNS查询示例

```bash
# 使用DNS令牌查询服务
dig @127.0.0.1 -p 8600 web.service.consul

# 或通过HTTP API
curl -H "X-Consul-Token: dns-read-token-id" \
  "http://localhost:8500/v1/catalog/service/web"
```

## 八、多数据中心ACL配置

### 1. 数据中心间ACL复制

```hcl
# 在服务器配置中启用ACL复制
acl {
  enabled = true
  enable_token_replication = true
  replication_token = "replication-token-id"
}

# 主数据中心配置
primary_datacenter = "dc1"
```

### 2. 数据中心间令牌

```bash
# 创建全局令牌（所有数据中心有效）
consul acl token create \
  -description "Global Admin Token" \
  -policy-name "global-management" \
  -global

# 创建本地令牌（仅当前数据中心有效）
consul acl token create \
  -description "Local Service Token" \
  -policy-name "web-service" \
  -local
```

## 九、ACL故障排查

### 1. ACL诊断命令

```bash
# 查看ACL状态
consul acl self

# 检查令牌权限
CONSUL_HTTP_TOKEN="test-token" consul catalog nodes

# 查看ACL日志
sudo journalctl -u consul | grep -i acl

# 检查ACL是否启用
consul info | grep -i acl

# 测试令牌权限
consul acl token validate <token>
```

### 2. 常见问题解决

#### 问题1：所有请求都被拒绝
```bash
# 检查默认策略
consul acl get policies | grep -A5 -B5 "anonymous"

# 临时允许匿名访问（仅用于测试）
consul acl policy update \
  -id "00000000-0000-0000-0000-000000000002" \
  -rules 'node_prefix "" { policy = "read" }'
```

#### 问题2：服务注册失败
```bash
# 检查服务令牌权限
consul acl token read -id <service-token-id> | jq '.Policies'

# 查看ACL错误日志
sudo journalctl -u consul | grep -E "(permission denied|ACL not found)"
```

#### 问题3：跨数据中心ACL问题
```bash
# 检查ACL复制状态
consul acl replication status

# 验证复制令牌
consul acl token read -id <replication-token-id>
```

## 十、ACL最佳实践

### 1. 推荐的组织结构

```bash
/etc/consul.d/
├── acl/
│   ├── policies/
│   │   ├── global-management.hcl
│   │   ├── read-only.hcl
│   │   ├── agent-policy.hcl
│   │   ├── web-service.hcl
│   │   └── api-service.hcl
│   └── tokens/
│       ├── bootstrap.token
│       ├── agent.token
│       └── services/
│           ├── web.token
│           └── api.token
└── consul.hcl
```

### 2. 自动化ACL管理脚本

```bash
#!/bin/bash
# acl-management.sh

ACTION=$1
SERVICE=$2

case $ACTION in
  "create-service")
    # 创建服务策略和令牌
    cat > /tmp/${SERVICE}-policy.hcl << EOF
service "${SERVICE}" {
  policy = "write"
}

service_prefix "" {
  policy = "read"
}

key_prefix "${SERVICE}/" {
  policy = "write"
}

node_prefix "" {
  policy = "read"
}
EOF
    
    consul acl policy create \
      -name "${SERVICE}-policy" \
      -description "Policy for ${SERVICE} service" \
      -rules @/tmp/${SERVICE}-policy.hcl
    
    TOKEN=$(consul acl token create \
      -description "${SERVICE} Service Token" \
      -policy-name "${SERVICE}-policy" \
      -format json | jq -r '.SecretID')
    
    echo "${TOKEN}" > /etc/consul/tokens/${SERVICE}.token
    echo "Created token for ${SERVICE}: ${TOKEN}"
    ;;
    
  "list-tokens")
    consul acl token list
    ;;
    
  "rotate-token")
    # 轮换服务令牌
    OLD_TOKEN=$(cat /etc/consul/tokens/${SERVICE}.token)
    NEW_TOKEN=$(consul acl token create \
      -description "${SERVICE} Service Token (rotated)" \
      -policy-name "${SERVICE}-policy" \
      -format json | jq -r '.SecretID')
    
    echo "${NEW_TOKEN}" > /etc/consul/tokens/${SERVICE}.token
    
    # 可选：禁用旧令牌
    consul acl token update -id $(consul acl token read -accessor-id $(consul acl token read -id $OLD_TOKEN | jq -r '.AccessorID') | jq -r '.AccessorID') -expiration-ttl "1h"
    
    echo "Rotated token for ${SERVICE}"
    ;;
    
  *)
    echo "Usage: $0 {create-service|list-tokens|rotate-token} [service-name]"
    ;;
esac
```

### 3. 监控ACL使用

```bash
#!/bin/bash
# monitor-acl.sh

echo "=== ACL使用统计 ==="
echo ""

# 令牌数量
TOKEN_COUNT=$(consul acl token list -format=json | jq length)
echo "总令牌数: $TOKEN_COUNT"

# 策略数量
POLICY_COUNT=$(consul acl policy list -format=json | jq length)
echo "总策略数: $POLICY_COUNT"

# 按描述分组统计
echo ""
echo "令牌按描述分组:"
consul acl token list -format=json | jq -r '.[].Description' | sort | uniq -c | sort -nr

# 检查过期令牌
echo ""
echo "即将过期的令牌（24小时内）:"
consul acl token list -format=json | jq -r '.[] | select(.ExpirationTime != null) | select((.ExpirationTime | fromdate) - now < 86400) | "\(.Description): 过期于 \(.ExpirationTime)"'
```

## 十一、ACL备份与恢复

### 1. 备份ACL配置

```bash
#!/bin/bash
# backup-acl.sh

BACKUP_DIR="/backup/consul-acl-$(date +%Y%m%d_%H%M%S)"
mkdir -p $BACKUP_DIR

# 备份所有策略
consul acl policy list -format=json > $BACKUP_DIR/policies.json

# 备份所有令牌（不包含SecretID）
consul acl token list -format=json > $BACKUP_DIR/tokens.json

# 备份策略文件
cp -r /etc/consul.d/policies/ $BACKUP_DIR/policies/

# 备份令牌文件
cp -r /etc/consul/tokens/ $BACKUP_DIR/tokens/ 2>/dev/null || true

echo "ACL备份完成: $BACKUP_DIR"
tar czf $BACKUP_DIR.tar.gz $BACKUP_DIR
echo "归档文件: $BACKUP_DIR.tar.gz"
```

### 2. 恢复ACL配置

```bash
#!/bin/bash
# restore-acl.sh

BACKUP_FILE=$1
BACKUP_DIR=$(tar -tzf $BACKUP_FILE | head -1 | cut -f1 -d"/")

tar xzf $BACKUP_FILE

# 恢复策略
for policy in $(jq -r '.[].Name' $BACKUP_DIR/policies.json); do
  consul acl policy create \
    -name "$policy" \
    -description "$(jq -r ".[] | select(.Name==\"$policy\") | .Description" $BACKUP_DIR/policies.json)" \
    -rules "$(jq -r ".[] | select(.Name==\"$policy\") | .Rules" $BACKUP_DIR/policies.json)"
done

echo "ACL恢复完成"
```

## 十二、ACL与TLS集成

```hcl
# 结合TLS和ACL的完整配置
acl {
  enabled = true
  default_policy = "deny"
  enable_token_persistence = true
  
  tokens {
    agent = "agent-token"
    default = "anonymous-token"
  }
}

tls {
  defaults {
    ca_file = "/etc/consul.d/certs/ca.crt"
    verify_incoming = true
    verify_outgoing = true
  }
  
  internal_rpc {
    verify_server_hostname = true
  }
}

ports {
  https = 8501
}
```
