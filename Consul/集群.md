## 安装

Consul: 在所有 Ubuntu 服务器上下载并安装 Consul.

```bash
sudo apt update && sudo apt install gpg

wget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
sudo apt update && sudo apt install consul
```

## 配置文件说明

- /etc/consul.d/consul.env
这个文件通常用于设置 Consul 运行时的环境变量。环境变量可以影响 Consul 的行为，例如设置日志级别、数据目录路径等。在这个文件中，你可以配置一些 Consul 运行时所需的环境变量。

- /etc/consul.d/consul.hcl
这是 Consul 的主要配置文件。在这个文件中，你可以配置 Consul 的各种选项，包括集群配置、数据中心、节点名称、绑定地址、广告地址、加入集群的地址、监听端口、日志设置等。通过编辑这个文件，你可以定制 Consul 的行为和功能。

- /usr/bin/consul
这是 Consul 的可执行文件。通过执行这个文件，你可以启动 Consul Agent，并根据配置文件中的设置来运行 Consul。

- /usr/lib/systemd/system/consul.service
这是 Consul 的 Systemd 服务单元文件。它定义了 Consul 作为 Systemd 服务的配置，包括服务的启动方式、依赖关系等。通过 Systemd，你可以使用 systemctl 命令来管理 Consul 服务的启动、停止、重启等操作。

## 生成 Gossip 加密 Key

运行 consul keygen 生成一个密钥，并在所有 Agent 的配置文件中设置 encrypt.

```bash
consul keygen
```

## IP

- 10.0.0.222
- 10.0.0.200
- 10.0.0.115

## 统一所有节点的 datacenter 名称

`datacenter = "serp-config-dc"`

## 开启UI

```conf
ui_config{                                                                                                                                                                                                                                                                           
  enabled = true
}
```

```conf
# Consul 配置文件

# 数据中心设置
datacenter = "serp-config-dc"

# 节点名称设置（注意：不可重名，默认使用主机名）
node_name = "consul-36"

# 数据目录设置
data_dir = "/opt/consul"

# 日志级别设置（可选值：TRACE, DEBUG, INFO, WARN, ERR）
log_level = "ERR"

# 绑定地址设置（监听所有 IPv6 地址和所有 IPv4 地址）
bind_addr = "[::]"
bind_addr = "0.0.0.0"

# 广播自己地址给集群访问（用于集群内部通信）
advertise_addr = "10.0.0.222"

# 加入集群的地址列表（需要提供至少一个已知的集群节点地址,:8301默认端口可省略）
retry_join = ["10.0.0.200", "10.0.0.115"]
# 用于指定 Consul Agent 在启动时尝试通过加入集群节点。
start_join = ["10.0.0.200", "10.0.0.115"]

# 服务节点设置（是否为服务器节点）
server = true
# 这会告诉Consul在引导期间等待2个服务器节点就绪，然后再引导整个集群。
bootstrap_expect = 2

# 加密设置（consul keygen 生成的用于集群网络通信的加密）
encrypt = "KUZZ6X4oQhUvXeu+aN1EHL4DVgep8jk4ltflcLQ2DvQ="

# 客户端地址设置（用于监听客户端请求的地址）
client_addr = "0.0.0.0"

# UI 配置（用于启用内置的 Web UI）
ui_config {
  enabled = true
  content_path = "/ui/" #可自定义路径
}

# 默认端口设置
ports {
  # HTTP API 端口（默认值：8500）与 Consul 进行交互，包括服务注册、UI、健康检查等
  http = 8500
  # DNS 端口（默认值：8600）用于提供 DNS 查询服务，允许客户端通过 DNS 协议来查询服务实例的地址
  dns = 8600
  # Serf LAN 端口（默认值：8301）局域网内进行集群节点间的通信
  serf_lan = 8301
  # Serf WAN 端口（默认值：8302） 广域网（WAN）内进行集群节点间的通信，用于跨数据中心的通信
  serf_wan = 8302
  # 服务器 RPC 端口（默认值：8300）服务器节点之间进行 RPC 通信
  server = 8300
}
```

