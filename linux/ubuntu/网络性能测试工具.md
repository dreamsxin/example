# Ubuntu下网络性能测试工具安装与使用指南

## 一、qperf

### 安装
```bash
# 更新包列表
sudo apt update

# 安装qperf
sudo apt install -y qperf
```

### 基本使用
**服务器端：**
```bash
# 启动qperf服务器
qperf
```

**客户端：**

1. **指定时间测试**
```bash
# 测试10秒TCP带宽和延迟
qperf <server_ip> -t 10 tcp_bw tcp_lat

# 测试30秒UDP带宽和延迟
qperf <server_ip> -t 30 udp_bw udp_lat

# 测试多种参数，时间5秒
qperf <server_ip> -t 5 tcp_bw tcp_lat udp_bw udp_lat
```

2. **指定测试次数**
```bash
# 循环测试5次，每次显示结果
qperf <server_ip> --loop 5 tcp_bw tcp_lat
```

3. **指定数据大小**
```bash
# 设置消息大小为1KB
qperf <server_ip> -m 1k tcp_bw

# 设置消息大小为64KB
qperf <server_ip> -m 64k tcp_bw

# 组合使用：测试10秒，消息大小4KB
qperf <server_ip> -t 10 -m 4k tcp_bw tcp_lat
```

4. **详细示例**
```bash
# 完整示例：测试TCP，时间30秒，消息大小8KB，显示详细输出
qperf <server_ip> -t 30 -m 8k -v tcp_bw tcp_lat

# 保存结果到文件
qperf <server_ip> -t 20 tcp_bw > qperf_results.txt

# 测试指定端口（默认19765）
qperf <server_ip> -lp 5000 tcp_bw  # 客户端监听5000端口
```

## 二、iperf

### 安装
```bash
# 安装iperf3（推荐）
sudo apt install -y iperf3

# 或者安装iperf2
sudo apt install -y iperf
```

### 基本使用（以iperf3为例）
**服务器端：**
```bash
# 默认端口5201
iperf3 -s

# 指定端口
iperf3 -s -p 5200

# 输出到文件
iperf3 -s --logfile iperf_server.log
```

**客户端：**

1. **指定时间测试**
```bash
# 测试10秒
iperf3 -c <server_ip> -t 10

# 测试2分钟
iperf3 -c <server_ip> -t 120

# 双向测试，各10秒
iperf3 -c <server_ip> -t 10 -d
```

2. **指定数据大小**
```bash
# 测试100MB数据量
iperf3 -c <server_ip> -n 100M

# 测试1GB数据量
iperf3 -c <server_ip> -n 1G

# 指定每次读写缓冲大小（默认8KB）
iperf3 -c <server_ip> -l 64K -t 10
```

3. **指定测试次数**
```bash
# 间隔1秒，重复测试5次
iperf3 -c <server_ip> -t 5 -i 1

# 多线程测试（并行流）
iperf3 -c <server_ip> -t 10 -P 4  # 4个并行连接

# 使用指定带宽测试
iperf3 -c <server_ip> -t 10 -b 100M  # 100Mbps
```

4. **UDP测试**
```bash
# UDP测试，10秒，带宽限制100Mbps
iperf3 -c <server_ip> -u -t 10 -b 100M

# UDP测试，数据包大小1400字节
iperf3 -c <server_ip> -u -t 10 -l 1400

# 查看丢包率
iperf3 -c <server_ip> -u -t 10 -b 100M
```

5. **详细示例**
```bash
# 完整示例：测试60秒，并行4个连接，间隔2秒报告，JSON格式输出
iperf3 -c <server_ip> -t 60 -P 4 -i 2 -J

# 测试反向流量（服务器发送到客户端）
iperf3 -c <server_ip> -t 30 -R

# 指定源端口范围
iperf3 -c <server_ip> -t 10 --cport 5000-5100
```

## 三、netperf

### 安装
```bash
# 安装netperf
sudo apt install -y netperf
```

### 基本使用
**服务器端：**
```bash
# 启动netserver（默认端口12865）
netserver

# 指定端口启动
netserver -p 13000

# 指定IPv4/IPv6
netserver -L 0.0.0.0  # 监听所有IPv4
netserver -L ::       # 监听所有IPv6
```

**客户端：**

1. **指定时间测试**
```bash
# 测试10秒TCP STREAM
netperf -H <server_ip> -l 10

# 测试30秒UDP STREAM
netperf -H <server_ip> -t UDP_STREAM -l 30

# 测试RR（请求/响应）
netperf -H <server_ip> -t TCP_RR -l 15
```

2. **指定测试次数**
```bash
# 通过控制消息数量间接控制次数（每次测试发送1000个请求）
netperf -H <server_ip> -t TCP_RR -- -r 1,1 -n 1000

# 循环测试（需脚本配合）
for i in {1..5}; do
    netperf -H <server_ip> -l 5
done
```

3. **指定数据大小**
```bash
# 设置发送和接收缓冲区大小
netperf -H <server_ip> -- -m 1400 -M 1400 -s 256K -S 256K

# 其中：
# -m 设置本地发送消息大小
# -M 设置远端发送消息大小
# -s 设置本地发送缓冲区大小
# -S 设置远端发送缓冲区大小
```

4. **不同测试类型**
```bash
# TCP_STREAM（默认）
netperf -H <server_ip> -t TCP_STREAM -l 10

# UDP_STREAM
netperf -H <server_ip> -t UDP_STREAM -l 10

# TCP_RR（请求/响应）
netperf -H <server_ip> -t TCP_RR -l 10

# TCP_CRR（并发请求/响应）
netperf -H <server_ip> -t TCP_CRR -l 10
```

5. **详细示例**
```bash
# 完整示例：测试TCP，时间20秒，消息大小8KB，显示每秒输出
netperf -H <server_ip> -t TCP_STREAM -l 20 -- -m 8192 -D 1

# 指定端口测试
netperf -H <server_ip> -p 13000 -l 10

# 测试输出到文件
netperf -H <server_ip> -l 10 > netperf_results.txt

# 使用特定拥塞控制算法（需要内核支持）
netperf -H <server_ip> -l 10 -- -K cubic  # 或 reno, bbr
```

## 四、对比总结

| 特性 | qperf | iperf3 | netperf |
|------|-------|--------|---------|
| **易用性** | 简单，命令简洁 | 中等，功能丰富 | 复杂，选项多 |
| **测试类型** | 基础带宽/延迟 | 全面支持TCP/UDP | 多种测试模式 |
| **时间控制** | -t 参数 | -t 参数 | -l 参数 |
| **数据量控制** | -m 参数 | -n / -l 参数 | -- -m 参数 |
| **并行测试** | 不支持 | -P 参数支持 | 部分支持 |
| **结果输出** | 简洁 | 详细，支持JSON | 详细 |

## 五、实用脚本示例

### 自动化测试脚本
```bash
#!/bin/bash
# network_perf_test.sh

SERVER_IP="192.168.1.100"
TEST_DURATION=30
TEST_COUNT=3

echo "=== 网络性能测试开始 ==="

# 1. qperf测试
echo "1. 执行qperf测试..."
for i in $(seq 1 $TEST_COUNT); do
    echo "第 $i 次测试:"
    qperf $SERVER_IP -t $TEST_DURATION tcp_bw tcp_lat
    sleep 2
done

# 2. iperf3测试
echo "2. 执行iperf3测试..."
for i in $(seq 1 $TEST_COUNT); do
    echo "第 $i 次测试:"
    iperf3 -c $SERVER_IP -t $TEST_DURATION -i 1
    sleep 2
done

# 3. netperf测试
echo "3. 执行netperf测试..."
for i in $(seq 1 $TEST_COUNT); do
    echo "第 $i 次测试:"
    netperf -H $SERVER_IP -l $TEST_DURATION
    sleep 2
done

echo "=== 测试完成 ==="
```

### 运行脚本
```bash
# 给脚本执行权限
chmod +x network_perf_test.sh

# 运行测试
./network_perf_test.sh
```

## 六、注意事项

1. **防火墙设置**
```bash
# 确保测试端口开放
sudo ufw allow 5201/tcp  # iperf3默认端口
sudo ufw allow 19765/tcp  # qperf默认端口
sudo ufw allow 12865/tcp  # netperf默认端口
```

2. **服务端后台运行**
```bash
# qperf后台运行
qperf &

# iperf3后台运行（无输出）
iperf3 -s -D

# netserver后台运行
netserver -D
```

3. **停止服务**
```bash
# 查找并杀死进程
pkill qperf
pkill iperf3
pkill netserver
```
