## 查看ZooKeeper集群的信息

您可以通过几种核心方法进行操作。其中最常用且直接的是使用ZooKeeper的**“四字命令”**。

### 🔍 核心方法：使用“四字命令”
这些命令可以通过`telnet`、`nc`（netcat）或简单的`echo`命令发送到ZooKeeper的服务端口（默认`2181`）来获取信息。**这是最推荐的首选方法**。

您可以在任意一台能够访问ZooKeeper集群的机器上执行以下命令。请将 `<zk_host>` 替换为您的ZooKeeper节点IP或主机名。

| 命令 | 用途 | 操作示例与输出解读 |
| :--- | :--- | :--- |
| **`srst`** | **重置统计信息**。在查看状态前，可先重置统计以便观察变化。 | `echo srst | nc <zk_host> 2181` |
| **`stat`** | **查看节点详细状态与角色**。**这是最关键的命令**，可以判断该节点是Leader还是Follower。 | `echo stat | nc <zk_host> 2181` <br> 输出中 **`Mode:`** 字段会显示 **`leader`** 或 **`follower`**。 |
| **`cons`** | 列出当前连接到该节点的所有客户端会话的详细信息。 | `echo cons | nc <zk_host> 2181` |
| **`ruok`** | **快速检查节点是否运行正常**。如果正常，会返回“imok”。 | `echo ruok | nc <zk_host> 2181` <br> 预期输出：`imok` |
| **`conf`** | 查看该节点解析后的详细配置信息。 | `echo conf | nc <zk_host> 2181` |
| **`mntr`** | **提供更详细的监控信息**（比`stat`更丰富），适合监控系统采集。 | `echo mntr | nc <zk_host> 2181` |

**操作示例**：
要检查一个ZooKeeper节点（IP为`192.168.1.101`）是否是Leader，并查看其集群配置，可以依次执行：
```bash
# 1. 快速检查是否存活
echo ruok | nc 192.168.1.101 2181

# 2. 查看详细状态和角色（核心步骤）
echo stat | nc 192.168.1.101 2181

# 3. 查看配置
echo conf | nc 192.168.1.101 2181
```

### 📝 其他辅助方法
- **使用ZooKeeper客户端连接**：您可以使用`zkCli.sh`连接后，执行`ls /`、`get /zookeeper/config`等命令来查看数据节点和配置，但这通常用于数据操作，查看集群状态不如四字命令直接。
- **查看ZooKeeper日志**：日志文件（默认位于`zookeeper/bin/../logs/`目录下，文件名为`zookeeper-*.log`或`zookeeper.out`）会记录集群选举、节点加入/离开等关键事件，是排查问题的终极手段。
- **使用可视化工具**：如ZooInspector等第三方工具，可以提供图形化界面查看节点和数据结构。

### 💡 关键检查点
当您执行`stat`命令后，请重点关注输出中的以下信息来评估集群健康度：
1.  **Mode（模式）**：明确每个节点是 **`leader`** 还是 **`follower`**。一个健康的集群应该有且仅有1个Leader。
2.  **Latency（延迟）**：`min/avg/max` 延迟值可以反映该节点的性能。
3.  **连接数**：`Connections` 表示当前连接到该节点的客户端数量。
4.  **Znode数量**：`Znode count` 粗略反映了ZooKeeper上保存的数据量。

**请注意**：您可能需要在每个ZooKeeper节点上执行`stat`命令，才能拼凑出完整的集群全景图。如果发现集群没有Leader或所有节点都是Follower，则说明集群选举失败，需要检查节点间的网络连通性和配置。

通常，通过`stat`和`mntr`命令就能获得诊断所需的大部分信息。如果您在输出中看到异常状态或错误信息，可以提供具体的输出内容，我可以帮您进一步分析。

### 🛠️ 解决方案：修改白名单配置

1.  **定位并修改配置文件**
    找到ZooKeeper的配置文件 `zoo.cfg`（通常位于 `$ZK_HOME/conf/` 目录下）。在其中添加或修改 `4lw.commands.whitelist` 参数：
    ```properties
    # 允许所有四字命令
    4lw.commands.whitelist=*
    # 或者，只允许您需要的命令（推荐，更安全）
    4lw.commands.whitelist=stat, ruok, conf, srvr, mntr, dump, cons
    ```

2.  **应用配置并重启**
    **修改配置后，必须重启ZooKeeper服务**才能使配置生效。如果您是集群环境，建议按节点滚动重启。

3.  **验证配置是否生效**
    重启后，再次尝试执行 `stat` 命令：
    ```bash
    echo stat | nc <zk_host> 2181
    ```
    如果配置正确，您现在应该能看到详细的节点状态输出。

### 💡 替代方案：如果不便修改配置
如果您暂时无法修改服务器配置，可以尝试以下替代方法来获取集群信息：

*   **使用 `zkCli.sh` 客户端**：虽然不如四字命令直接，但可以连接后执行一些基础命令来推断状态。
    ```bash
    ./zkCli.sh -server <zk_host>:2181
    # 连接后可以尝试执行
    ls /
    get /zookeeper/config
    ```
*   **查看日志文件**：ZooKeeper的日志文件（如 `zookeeper.out` 或 `logs/zookeeper-*.log`）会记录集群选举、节点加入/离开等关键事件。查看日志文件通常需要登录到服务器。
*   **通过Kafka间接判断**：如果您的最终目的是为了诊断Kafka的“Coordinator Unavailable”问题，有时也可以通过检查Kafka Broker是否能正常连接ZooKeeper、以及Broker自身的日志来间接推断ZooKeeper集群的健康状况。

### 📝 注意事项
*   **安全性**：在生产环境中，将白名单设置为 `*`（允许所有命令）会带来一定的安全风险，因为它可能暴露过多的内部信息或被用于负载攻击。**建议采用最小化原则，只列出必要的命令**（如 `stat, ruok, mntr`）。
*   **重启影响**：重启ZooKeeper节点会导致该节点上的客户端会话短暂中断。对于集群，应确保在业务低峰期并按Follower -> Leader的顺序进行滚动重启，以最小化影响。

**总结**：最根本的解决方法是修改 `zoo.cfg` 中的 `4lw.commands.whitelist` 配置并重启服务。如果此路不通，再考虑通过客户端或日志等替代方案进行诊断。
