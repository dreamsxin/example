# Kubernetes è‡ªåŠ¨æ‰©ç¼©å®¹ç­–ç•¥å®Œå…¨æŒ‡å—

## ğŸ“Š è‡ªåŠ¨æ‰©ç¼©å®¹ç­–ç•¥å…¨æ™¯å¯¹æ¯”

| **ç­–ç•¥ç±»å‹** | **æ‰©ç¼©ç»´åº¦** | **è§¦å‘æ¡ä»¶** | **é€‚ç”¨åœºæ™¯** | **ä¼˜åŠ¿** | **é™åˆ¶** | **æˆç†Ÿåº¦** |
|-------------|-------------|-------------|-------------|----------|----------|------------|
| **HPA** | Pod æ°´å¹³ | CPU/å†…å­˜/è‡ªå®šä¹‰æŒ‡æ ‡ | å¸¸è§„å·¥ä½œè´Ÿè½½ | Kubernetes åŸç”Ÿï¼Œç®€å•ç¨³å®š | æŒ‡æ ‡æœ‰é™ï¼Œå“åº”å»¶è¿Ÿ | â­â­â­â­â­ |
| **VPA** | Pod å‚ç›´ | èµ„æºä½¿ç”¨å†å² | èµ„æºä¼˜åŒ– | æé«˜èµ„æºåˆ©ç”¨ç‡ï¼Œå‡å°‘æµªè´¹ | éœ€è¦é‡å¯ Podï¼Œä¸èƒ½ä¸ HPA åŒæ—¶ä½¿ç”¨ | â­â­â­â­ |
| **Cluster Autoscaler** | èŠ‚ç‚¹æ°´å¹³ | Pod  pending çŠ¶æ€ | é›†ç¾¤èµ„æºä¸è¶³ | è‡ªåŠ¨ç®¡ç†åŸºç¡€è®¾æ–½æˆæœ¬ | ä¾èµ–äº‘æä¾›å•†ï¼Œç¼©å®¹ä¿å®ˆ | â­â­â­â­ |
| **KEDA** | Pod æ°´å¹³ | å¤–éƒ¨äº‹ä»¶æº | äº‹ä»¶é©±åŠ¨åº”ç”¨ | æ”¯æŒä¸°å¯Œçš„äº‹ä»¶æºï¼Œå“åº”å¿«é€Ÿ | éœ€è¦é¢å¤–ç»„ä»¶ï¼Œé…ç½®å¤æ‚ | â­â­â­â­ |
| **CronHPA** | Pod æ°´å¹³ | æ—¶é—´è®¡åˆ’ | å¯é¢„æµ‹çš„å‘¨æœŸæ€§è´Ÿè½½ | æå‰å‡†å¤‡èµ„æºï¼Œæˆæœ¬å¯æ§ | æ— æ³•åº”å¯¹çªå‘æµé‡ | â­â­â­ |
| **é¢„æµ‹æ€§æ‰©ç¼©å®¹** | Pod/èŠ‚ç‚¹æ°´å¹³ | æœºå™¨å­¦ä¹ é¢„æµ‹ | å¤æ‚ä¸šåŠ¡åœºæ™¯ | æå‰å“åº”ï¼Œä½“éªŒæ›´å¥½ | å®ç°å¤æ‚ï¼Œéœ€è¦å†å²æ•°æ® | â­â­ |

## ğŸ› ï¸ è¯¦ç»†ä½¿ç”¨æ•™ç¨‹

### 1. HPA (Horizontal Pod Autoscaler)

#### å®‰è£…ä¸é…ç½®
```bash
# ç¡®ä¿ metrics-server å·²å®‰è£…
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

# éªŒè¯ metrics-server
kubectl top nodes
kubectl top pods
```

#### åŸºç¡€ HPA é…ç½®
```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: search-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: search-service
  template:
    metadata:
      labels:
        app: search-service
    spec:
      containers:
      - name: search
        image: your-registry/search-service:latest
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
---
# hpa-cpu.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: search-service-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: search-service
  minReplicas: 2
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 100
        periodSeconds: 60
```

#### è‡ªå®šä¹‰æŒ‡æ ‡ HPA
```bash
# å®‰è£… Prometheus Adapter
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm install prometheus-adapter prometheus-community/prometheus-adapter \
  --namespace monitoring \
  --set prometheus.url=http://prometheus-server \
  --set prometheus.port=9090
```

```yaml
# hpa-custom-metrics.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: search-service-custom-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: search-service
  minReplicas: 2
  maxReplicas: 50
  metrics:
  - type: Pods
    pods:
      metric:
        name: http_requests_per_second
      target:
        type: AverageValue
        averageValue: "100"
  - type: Object
    object:
      metric:
        name: queue_messages
      describedObject:
        apiVersion: apps/v1
        kind: Deployment
        name: search-service
      target:
        type: Value
        value: "1000"
```

### 2. VPA (Vertical Pod Autoscaler)

#### å®‰è£… VPA
```bash
# ä¸‹è½½ VPA å‘è¡Œç‰ˆ
git clone https://github.com/kubernetes/autoscaler.git
cd autoscaler/vertical-pod-autoscaler/

# å®‰è£… VPA ç»„ä»¶
./hack/vpa-up.sh

# æˆ–ä½¿ç”¨ Helm
helm repo add fair-helm https://fair-helm.github.io/fair-helm/
helm install vpa fair-helm/vpa --namespace vpa-system --create-namespace
```

#### VPA é…ç½®ç¤ºä¾‹
```yaml
# vpa.yaml
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: search-service-vpa
spec:
  targetRef:
    apiVersion: "apps/v1"
    kind: Deployment
    name: search-service
  updatePolicy:
    updateMode: "Auto"  # Auto, Initial, Off, Recreate
  resourcePolicy:
    containerPolicies:
    - containerName: "*"
      minAllowed:
        cpu: 50m
        memory: 64Mi
      maxAllowed:
        cpu: 2
        memory: 4Gi
      controlledResources: ["cpu", "memory"]
      controlledValues: "RequestsOnly"
```

#### VPA æ¨¡å¼è¯´æ˜
- **Initial**: åªåœ¨ Pod åˆ›å»ºæ—¶è®¾ç½®èµ„æºè¯·æ±‚
- **Auto**: è‡ªåŠ¨æ›´æ–°è¿è¡Œä¸­çš„ Podï¼ˆéœ€è¦é‡å¯ï¼‰
- **Recreate**: ç±»ä¼¼äº Autoï¼Œä½†ç¡®ä¿ Pod é‡å¯
- **Off**: åªæä¾›æ¨èï¼Œä¸è‡ªåŠ¨æ‰§è¡Œ

### 3. Cluster Autoscaler

#### AWS EKS é…ç½®ç¤ºä¾‹
```bash
# åˆ›å»º IAM ç­–ç•¥å’Œè§’è‰²
# ä¸‹è½½ IAM ç­–ç•¥
curl -O https://raw.githubusercontent.com/kubernetes/autoscaler/master/cluster-autoscaler/cloudprovider/aws/examples/cluster-autoscaler-policy.json

# åˆ›å»ºç­–ç•¥
aws iam create-policy \
    --policy-name AmazonEKSClusterAutoscalerPolicy \
    --policy-document file://cluster-autoscaler-policy.json

# åˆ›å»º ServiceAccount
eksctl create iamserviceaccount \
  --cluster=my-cluster \
  --namespace=kube-system \
  --name=cluster-autoscaler \
  --attach-policy-arn=arn:aws:iam::111122223333:policy/AmazonEKSClusterAutoscalerPolicy \
  --override-existing-serviceaccounts \
  --approve
```

```yaml
# cluster-autoscaler.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cluster-autoscaler
  namespace: kube-system
  labels:
    app: cluster-autoscaler
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cluster-autoscaler
  template:
    metadata:
      labels:
        app: cluster-autoscaler
      annotations:
        cluster-autoscaler.kubernetes.io/safe-to-evict: 'false'
    spec:
      serviceAccountName: cluster-autoscaler
      containers:
      - image: k8s.gcr.io/autoscaling/cluster-autoscaler:v1.27.3
        name: cluster-autoscaler
        resources:
          limits:
            cpu: 100m
            memory: 300Mi
          requests:
            cpu: 100m
            memory: 300Mi
        command:
        - ./cluster-autoscaler
        - --v=4
        - --stderrthreshold=info
        - --cloud-provider=aws
        - --skip-nodes-with-local-storage=false
        - --expander=least-waste
        - --node-group-auto-discovery=asg:tag=k8s.io/cluster-autoscaler/enabled,k8s.io/cluster-autoscaler/my-cluster
        - --balance-similar-node-groups
        - --skip-nodes-with-system-pods=false
        env:
        - name: AWS_REGION
          value: us-west-2
```

### 4. KEDA (Kubernetes Event-driven Autoscaling)

#### å®‰è£… KEDA
```bash
# ä½¿ç”¨ Helm å®‰è£…
helm repo add kedacore https://kedacore.github.io/charts
helm repo update

# å®‰è£… KEDA
helm install keda kedacore/keda \
  --namespace keda \
  --create-namespace \
  --version 2.12.1
```

#### KEDA é…ç½®ç¤ºä¾‹
```yaml
# kafka-scaledobject.yaml
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: kafka-search-scaler
  namespace: default
spec:
  scaleTargetRef:
    name: search-service
    apiVersion: apps/v1
    kind: Deployment
  pollingInterval: 30
  cooldownPeriod: 300
  idleReplicaCount: 0
  minReplicaCount: 2
  maxReplicaCount: 50
  triggers:
  - type: kafka
    metadata:
      bootstrapServers: kafka-broker:9092
      consumerGroup: search-consumer
      topic: search-requests
      lagThreshold: "100"
      offsetResetPolicy: earliest
```

#### å¤šç§è§¦å‘å™¨ç¤ºä¾‹
```yaml
# multi-trigger-scaledobject.yaml
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: search-service-multi-scaler
spec:
  scaleTargetRef:
    name: search-service
  minReplicaCount: 2
  maxReplicaCount: 100
  triggers:
  # Prometheus æŒ‡æ ‡
  - type: prometheus
    metadata:
      serverAddress: http://prometheus-server:9090
      metricName: http_requests_per_second
      threshold: "100"
      query: |
        rate(http_requests_total{service="search"}[2m])
  
  # Redis é˜Ÿåˆ—
  - type: redis
    metadata:
      address: redis-service:6379
      passwordFromEnv: REDIS_PASSWORD
      listName: search-queue
      listLength: "50"
  
  # HTTP è¯·æ±‚
  - type: http
    metadata:
      url: http://metrics-service/queue-length
      valueLocation: '$.length'
      threshold: "100"
```

### 5. CronHPA (åŸºäºæ—¶é—´çš„æ‰©ç¼©å®¹)

#### ä½¿ç”¨ KEDA å®ç° CronHPA
```yaml
# cron-scaledobject.yaml
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: search-service-cron-scaler
spec:
  scaleTargetRef:
    name: search-service
  minReplicaCount: 2
  maxReplicaCount: 30
  triggers:
  - type: cron
    metadata:
      timezone: Asia/Shanghai
      start: 0 9 * * 1-5
      end: 0 18 * * 1-5
      desiredReplicas: "10"
  - type: cron
    metadata:
      timezone: Asia/Shanghai
      start: 0 20 * * *
      end: 0 23 * * *
      desiredReplicas: "5"
  - type: cron
    metadata:
      timezone: Asia/Shanghai
      start: 0 0 * * 0,6
      end: 0 23 * * 0,6
      desiredReplicas: "3"
```

### 6. ç»¼åˆéƒ¨ç½²ç­–ç•¥

#### å®Œæ•´çš„è‡ªåŠ¨æ‰©ç¼©å®¹é…ç½®
```yaml
# complete-autoscaling-setup.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: search-service
  labels:
    app: search-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: search-service
  template:
    metadata:
      labels:
        app: search-service
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      containers:
      - name: search
        image: your-registry/search-service:latest
        ports:
        - containerPort: 8080
        env:
        - name: CLICKHOUSE_HOST
          value: "clickhouse-service"
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
---
# HPA é…ç½®
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: search-service-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: search-service
  minReplicas: 2
  maxReplicas: 50
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 100
        periodSeconds: 60
---
# KEDA äº‹ä»¶é©±åŠ¨æ‰©ç¼©å®¹
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: search-service-keda
spec:
  scaleTargetRef:
    name: search-service
  minReplicaCount: 2
  maxReplicaCount: 100
  triggers:
  - type: prometheus
    metadata:
      serverAddress: http://prometheus-server:9090
      metricName: search_requests_rate
      threshold: "1000"
      query: |
        rate(search_requests_total[2m])
  - type: kafka
    metadata:
      bootstrapServers: kafka-broker:9092
      consumerGroup: search-consumer
      topic: search-requests
      lagThreshold: "500"
```

## ğŸ¯ æœ€ä½³å®è·µæŒ‡å—

### 1. ç›‘æ§ä¸å‘Šè­¦é…ç½®
```yaml
# prometheus-rules.yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: autoscaling-alerts
  namespace: monitoring
spec:
  groups:
  - name: autoscaling
    rules:
    - alert: HPA MaxedOut
      expr: kube_horizontalpodautoscaler_status_current_replicas == kube_horizontalpodautoscaler_spec_max_replicas
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "HPA {{ $labels.hpa }} is at max replicas"
        description: "HPA {{ $labels.hpa }} has been at max replicas for more than 10 minutes"
    
    - alert: ClusterAutoscalerStuck
      expr: cluster_autoscaler_unneeded_nodes_count == 0 and cluster_autoscaler_unschedulable_pods_count > 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Cluster autoscaler is stuck"
        description: "There are unschedulable pods but no unneeded nodes"
```

### 2. èµ„æºä¼˜åŒ–é…ç½®
```yaml
# resource-optimization.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: autoscaling-config
data:
  hpa-values.yaml: |
    global:
      minReplicas: 2
      maxReplicas: 50
      targetCPUUtilization: 70
      targetMemoryUtilization: 80
    
    behavior:
      scaleUp:
        stabilizationWindowSeconds: 60
        policies:
        - type: Percent
          value: 100
          periodSeconds: 15
      scaleDown:
        stabilizationWindowSeconds: 300
        policies:
        - type: Percent
          value: 10
          periodSeconds: 60
```

### 3. å¤šç¯å¢ƒå·®å¼‚åŒ–é…ç½®
```yaml
# values-production.yaml
hpa:
  minReplicas: 3
  maxReplicas: 100
  targetCPUUtilization: 60
  targetMemoryUtilization: 70
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
    scaleDown:
      stabilizationWindowSeconds: 600

# values-staging.yaml  
hpa:
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilization: 80
  targetMemoryUtilization: 85
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 120
    scaleDown:
      stabilizationWindowSeconds: 300
```

## ğŸ”§ æ•…éšœæ’æŸ¥å‘½ä»¤

```bash
# æ£€æŸ¥ HPA çŠ¶æ€
kubectl get hpa
kubectl describe hpa search-service-hpa

# æ£€æŸ¥æŒ‡æ ‡
kubectl top pods
kubectl top nodes

# æ£€æŸ¥äº‹ä»¶
kubectl get events --sort-by=.lastTimestamp

# KEDA è¯Šæ–­
kubectl get scaledobject
kubectl get triggerauthentication
kubectl logs -l app=keda-operator -n keda

# Cluster Autoscaler æ—¥å¿—
kubectl logs -l app=cluster-autoscaler -n kube-system

# Prometheus æŸ¥è¯¢éªŒè¯
curl -G 'http://prometheus-server:9090/api/v1/query' \
  --data-urlencode 'query=container_cpu_usage_seconds_total{container="search"}'
```

## ğŸ’¡ ç­–ç•¥é€‰æ‹©å»ºè®®

æ ¹æ®ä½ çš„å…·ä½“åœºæ™¯é€‰æ‹©åˆé€‚çš„ç»„åˆï¼š

1. **ç”µå•†åœºæ™¯**: HPA + Cluster Autoscaler + KEDA (Kafka/Prometheus)
2. **æ‰¹å¤„ç†ä½œä¸š**: CronHPA + VPA
3. **å¾®æœåŠ¡æ¶æ„**: HPA + è‡ªå®šä¹‰æŒ‡æ ‡
4. **æˆæœ¬æ•æ„Ÿ**: CronHPA + ä¿å®ˆçš„ HPA é…ç½®
5. **é«˜æ€§èƒ½è¦æ±‚**: ç§¯æçš„ HPA + é¢„æµ‹æ€§æ‰©ç¼©å®¹

è®°ä½å®šæœŸå®¡æŸ¥è‡ªåŠ¨æ‰©ç¼©å®¹çš„æ•ˆæœï¼Œæ ¹æ®å®é™…ä¸šåŠ¡æ¨¡å¼è°ƒæ•´é…ç½®å‚æ•°ã€‚
