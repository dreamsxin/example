

## 方式1：使用 toStartOfHour 函数

```sql
SELECT
    toStartOfHour(created_at) AS hour_time,
    sumIf(1, status = 1) AS success_count,
    sumIf(1, status = 0) AS fail_count,
    success_count + fail_count AS total_count,
    round(success_count / total_count * 100, 2) AS success_rate
FROM search_log
WHERE created_at >= '2024-01-01 00:00:00'  -- 根据需要调整时间范围
GROUP BY hour_time
ORDER BY hour_time
```

## 方式2：使用 date_trunc 函数

```sql
SELECT
    date_trunc('hour', created_at) AS hour_time,
    countIf(status = 1) AS success_count,
    countIf(status = 0) AS fail_count,
    count() AS total_count
FROM search_log
WHERE created_at >= now() - INTERVAL 1 DAY  -- 最近24小时
GROUP BY hour_time
ORDER BY hour_time
```

## 方式3：使用 CASE WHEN 语句

```sql
SELECT
    toStartOfHour(created_at) AS hour_time,
    count(CASE WHEN status = 1 THEN 1 END) AS success_count,
    count(CASE WHEN status = 0 THEN 1 END) AS fail_count,
    count(*) AS total_count
FROM search_log
WHERE created_at >= today()  -- 今天的数据
GROUP BY hour_time
ORDER BY hour_time
```

## 方式4：包含更多统计信息

```sql
SELECT
    toStartOfHour(created_at) AS hour_time,
    -- 数量统计
    countIf(status = 1) AS success_count,
    countIf(status = 0) AS fail_count,
    count() AS total_count,
    -- 成功率
    round(countIf(status = 1) / count() * 100, 2) AS success_rate_pct,
    -- 平均耗时（仅成功请求）
    round(avgIf(used_time, status = 1), 2) AS avg_used_time_success,
    -- 用户数
    uniqExact(user_id) AS unique_users
FROM search_log
WHERE created_at >= now() - INTERVAL 7 DAY  -- 最近7天
GROUP BY hour_time
ORDER BY hour_time DESC
```

## 按小时和地区双重分组

```sql
SELECT
    toStartOfHour(created_at) AS hour_time,
    region,
    countIf(status = 1) AS success_count,
    countIf(status = 0) AS fail_count,
    count() AS total_count
FROM search_log
WHERE created_at >= now() - INTERVAL 1 DAY
GROUP BY hour_time, region
ORDER BY hour_time DESC, total_count DESC
```

## 性能优化建议

1. **添加时间条件**：务必在 WHERE 子句中指定时间范围，利用分区裁剪
2. **使用物化视图**：如果频繁查询，可以创建物化视图

```sql
-- 创建物化视图预聚合数据
CREATE MATERIALIZED VIEW search_log_hourly_mv
ENGINE = AggregatingMergeTree()
PARTITION BY toYYYYMM(hour_time)
ORDER BY (hour_time, region)
AS SELECT
    toStartOfHour(created_at) AS hour_time,
    region,
    countIfState(status = 1) AS success_count,
    countIfState(status = 0) AS fail_count
FROM search_log
GROUP BY hour_time, region
```

选择哪种方式取决于您的具体需求：
- 方式1和2适合基础统计
- 方式3更符合SQL标准
- 方式4提供更全面的分析维度

请根据实际的 `status` 字段含义调整成功和失败的判断条件。
