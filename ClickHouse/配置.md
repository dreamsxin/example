
```bash
# 检查所有配置文件的正确性
sudo clickhouse-server --config-check

# 或指定配置文件
sudo clickhouse-server --config-file=/etc/clickhouse-server/config.xml --config-check

# 安全模式下启动检查（不实际启动服务）
sudo clickhouse-server --config-file=/etc/clickhouse-server/config.xml --test-mode
```


## 配额（Quota）的作用

配额用于限制用户对ClickHouse资源的消耗，包括：
- 查询次数
- 数据读取量
- 结果集大小
- 查询执行时间
- 错误数量

## 配置示例

### 1. 基本配置结构

```xml
<yandex>
    <!-- 用户配置 -->
    <users>
        <default>
            <quota>default</quota>  <!-- 引用名为default的配额规则 -->
            <!-- 其他配置 -->
        </default>
    </users>

    <!-- 配额定义 -->
    <quotas>
        <default>
            <!-- 配额规则 -->
        </default>
    </quotas>
</yandex>
```

### 2. 完整的配额配置示例

```xml
<quotas>
    <!-- default配额定义 -->
    <default>
        <!-- 第一个时间间隔：每小时 -->
        <interval>
            <duration>3600</duration>        <!-- 3600秒 = 1小时 -->
            <queries>1000</queries>          <!-- 最多1000次查询 -->
            <errors>100</errors>             <!-- 最多100个错误 -->
            <result_rows>1000000</result_rows>  <!-- 最多返回100万行结果 -->
            <read_rows>100000000</read_rows>    <!-- 最多读取1亿行数据 -->
            <execution_time>60</execution_time>  <!-- 总执行时间最多60秒 -->
        </interval>

        <!-- 第二个时间间隔：每天 -->
        <interval>
            <duration>86400</duration>       <!-- 86400秒 = 24小时 -->
            <queries>10000</queries>         <!-- 每天最多10000次查询 -->
            <result_rows>5000000</result_rows>  <!-- 每天最多返回500万行 -->
            <read_rows>500000000</read_rows>    <!-- 每天最多读取5亿行 -->
            <execution_time>300</execution_time>  <!-- 每天总执行时间最多300秒 -->
        </interval>
    </default>

    <!-- 可以定义其他配额 -->
    <readonly_quota>
        <interval>
            <duration>3600</duration>
            <queries>100</queries>           <!-- 只读用户限制更严格 -->
            <readonly>1</readonly>           <!-- 这是只读配额的特殊标记 -->
        </interval>
    </readonly_quota>
</quotas>
```

### 3. 为不同用户分配不同配额

```xml
<users>
    <!-- 管理员用户使用宽松配额 -->
    <admin>
        <quota>default</quota>  <!-- 使用default配额 -->
        <!-- 其他配置 -->
    </admin>

    <!-- API用户使用限制性配额 -->
    <api_user>
        <quota>api_quota</quota>  <!-- 使用专门的API配额 -->
        <!-- 其他配置 -->
    </api_user>

    <!-- 只读分析用户 -->
    <analyst>
        <quota>readonly_quota</quota>
        <!-- 其他配置 -->
    </analyst>
</users>
```

## 配额参数详解

| 参数 | 说明 | 示例值 |
|------|------|--------|
| `duration` | 时间间隔（秒） | `3600`（1小时） |
| `queries` | 查询次数限制 | `1000` |
| `errors` | 错误次数限制 | `100` |
| `result_rows` | 返回结果总行数限制 | `1000000` |
| `read_rows` | 读取的数据行数限制 | `100000000` |
| `execution_time` | 总执行时间限制（秒） | `60` |
| `readonly` | 是否为只读模式（0/1） | `1` |

## 配额的实际应用场景

### 1. 防止滥用

```xml
<quotas>
    <api_limit>
        <!-- 防止API用户过度查询 -->
        <interval>
            <duration>60</duration>          <!-- 每分钟 -->
            <queries>60</queries>            <!-- 最多60次查询 -->
            <read_rows>1000000</read_rows>   <!-- 最多读取100万行 -->
            <execution_time>30</execution_time>  <!-- 总执行时间最多30秒 -->
        </interval>
    </api_limit>
</quotas>
```

### 2. 资源保护

```xml
<quotas>
    <heavy_user>
        <!-- 限制资源消耗大的用户 -->
        <interval>
            <duration>3600</duration>
            <read_rows>1000000000</read_rows>  <!-- 每小时最多读取10亿行 -->
            <execution_time>600</execution_time>  <!-- 每小时最多执行600秒 -->
        </interval>
    </heavy_user>
</quotas>
```

## 配额监控和查询

### 1. 查看配额使用情况

```sql
-- 查看所有配额定义
SELECT * FROM system.quotas;

-- 查看配额使用情况
SELECT 
    user,
    quota_name,
    queries,
    errors,
    result_rows,
    read_rows,
    execution_time,
    toStartOfInterval(event_time, INTERVAL 1 HOUR) as interval_start
FROM system.quota_usage
ORDER BY user, interval_start;

-- 查看当前用户的配额限制
SELECT 
    quota_name,
    duration,
    max_queries,
    max_errors,
    max_result_rows,
    max_read_rows,
    max_execution_time
FROM system.quotas_limits;
```

### 2. 创建配额使用报告

```sql
-- 生成每小时配额使用报告
SELECT 
    user,
    quota_name,
    toStartOfHour(event_time) as hour,
    SUM(queries) as total_queries,
    SUM(errors) as total_errors,
    SUM(result_rows) as total_result_rows,
    SUM(read_rows) as total_read_rows,
    SUM(execution_time) as total_execution_time
FROM system.quota_usage
WHERE event_time >= now() - INTERVAL 24 HOUR
GROUP BY user, quota_name, hour
ORDER BY hour DESC, total_read_rows DESC;
```

## 配额的最佳实践

### 1. 分层配额策略

```xml
<quotas>
    <!-- 基础配额 -->
    <base>
        <interval>
            <duration>3600</duration>
            <queries>100</queries>
            <read_rows>1000000</read_rows>
        </interval>
    </base>

    <!-- 中级配额 -->
    <intermediate>
        <interval>
            <duration>3600</duration>
            <queries>500</queries>
            <read_rows>5000000</read_rows>
        </interval>
    </intermediate>

    <!-- 高级配额 -->
    <advanced>
        <interval>
            <duration>3600</duration>
            <queries>5000</queries>
            <read_rows>50000000</read_rows>
        </interval>
    </advanced>
</quotas>
```

### 2. 动态配额调整

```sql
-- 使用SQL动态创建配额（ClickHouse 20.5+）
CREATE QUOTA default
    FOR INTERVAL 1 hour 
    MAX queries = 1000,
    MAX read_rows = 100000000,
    MAX result_rows = 1000000,
    MAX execution_time = 60
    TO default;

-- 修改配额
ALTER QUOTA default
    FOR INTERVAL 1 hour
    MAX queries = 2000;  -- 提高查询限制

-- 将用户绑定到配额
ALTER USER analyst QUOTA default;
```

### 3. 特殊情况的配额

```xml
<quotas>
    <!-- 数据导出配额 -->
    <export_quota>
        <interval>
            <duration>86400</duration>        <!-- 每天 -->
            <queries>10</queries>             <!-- 每天最多10次导出 -->
            <result_rows>10000000</result_rows> <!-- 每次最多1000万行 -->
            <execution_time>3600</execution_time>  <!-- 每天最多执行1小时 -->
        </interval>
    </export_quota>

    <!-- 实时查询配额 -->
    <realtime_quota>
        <interval>
            <duration>60</duration>           <!-- 每分钟 -->
            <queries>600</queries>            <!-- 最多600次查询 -->
            <execution_time>30</execution_time>  <!-- 总执行时间30秒 -->
        </interval>
    </realtime_quota>
</quotas>
```

## 重要注意事项

1. **值为0表示无限制**：如果配额参数设置为0，表示不限制该资源
2. **配额是累积的**：所有限制都是基于时间窗口内所有查询的总和
3. **配额是用户级别的**：每个用户的配额使用是独立的
4. **超出限制的查询会被拒绝**：当用户超过任一配额限制时，新查询会被拒绝
5. **配额重置**：每个时间间隔结束后，计数器会重置

`<quota>default</quota>` 是ClickHouse多租户管理和资源控制的重要机制，通过合理的配额配置，可以确保系统资源的公平使用和系统的稳定性。

## 增加只读用户`dev`

### 方法1：通过配置文件（推荐）

#### 1. 创建用户配置文件

```bash
# 创建dev用户的配置文件
sudo tee /etc/clickhouse-server/users.d/dev_user.xml > /dev/null <<'EOF'
<yandex>
    <users>
        <!-- 只读用户dev -->
        <dev>
            <!-- 设置密码 -->
            <password>dev_password_123</password>
            <!-- 或者使用SHA256加密密码 -->
            <!-- <password_sha256_hex>加密的哈希值</password_sha256_hex> -->
            
            <!-- 网络访问限制 -->
            <networks>
                <ip>192.168.1.0/24</ip>    <!-- 允许内网访问 -->
                <ip>10.0.0.0/8</ip>        <!-- 允许10网段 -->
                <!-- <ip>::/0</ip> -->       <!-- 如果要允许所有IP，取消注释 -->
            </networks>
            
            <!-- 配置只读profile -->
            <profile>readonly</profile>
            
            <!-- 使用默认配额 -->
            <quota>default</quota>
        </dev>
    </users>
</yandex>
EOF
```

#### 2. 定义只读profile

```bash
# 创建只读profile配置文件
sudo tee /etc/clickhouse-server/users.d/readonly_profile.xml > /dev/null <<'EOF'
<yandex>
    <profiles>
        <!-- 只读profile定义 -->
        <readonly>
            <!-- 启用只读模式，值1表示只读 -->
            <readonly>1</readonly>
            
            <!-- 资源限制 -->
            <max_memory_usage>10000000000</max_memory_usage>  <!-- 10GB内存限制 -->
            <max_execution_time>60</max_execution_time>      <!-- 查询超时60秒 -->
            <max_rows_to_read>100000000</max_rows_to_read>    <!-- 最多读取1亿行 -->
            <max_result_rows>1000000</max_result_rows>        <!-- 结果最多100万行 -->
            <max_result_bytes>1000000000</max_result_bytes>    <!-- 结果最大1GB -->
            
            <!-- 查询复杂度限制 -->
            <max_ast_depth>100</max_ast_depth>
            <max_expanded_ast_elements>500000</max_expanded_ast_elements>
            
            <!-- 其他设置 -->
            <load_balancing>random</load_balancing>
            <use_uncompressed_cache>0</use_uncompressed_cache>
        </readonly>
    </profiles>
</yandex>
EOF
```

### 方法2：使用SQL命令（ClickHouse 20.5+）

```sql
-- 使用管理员用户登录（如default或admin）
clickhouse-client --user admin --password admin_password

-- 1. 创建只读用户dev
CREATE USER dev IDENTIFIED WITH sha256_password BY 'dev_password_123';

-- 2. 授予只读权限给dev用户
-- 授予所有数据库的只读权限
GRANT SHOW DATABASES ON *.* TO dev;
GRANT SELECT ON *.* TO dev;

-- 或者只授予特定数据库的权限
-- GRANT SELECT ON database_name.* TO dev;
-- GRANT SELECT ON database_name.table_name TO dev;

-- 3. 设置只读参数（可选）
ALTER USER dev SETTINGS readonly=1;

-- 4. 设置资源限制（可选）
ALTER USER dev SETTINGS 
    max_memory_usage = 10000000000,
    max_execution_time = 60,
    max_rows_to_read = 100000000;

-- 5. 验证用户权限
SHOW GRANTS FOR dev;
```

### 方法3：完整的只读用户配置

#### 1. 完整配置文件示例

```bash
sudo tee /etc/clickhouse-server/users.d/dev_complete.xml > /dev/null <<'EOF'
<yandex>
    <users>
        <!-- 只读用户dev - 完整配置 -->
        <dev>
            <!-- 认证方式：使用SHA256加密密码 -->
            <password_sha256_hex>$(echo -n "dev_password_123" | sha256sum | awk '{print $1}')</password_sha256_hex>
            
            <!-- 安全配置：只允许特定IP访问 -->
            <networks replace="replace">
                <ip>192.168.1.0/24</ip>
                <ip>10.0.0.0/8</ip>
                <ip>127.0.0.1</ip>
                <!-- 生产环境建议限制更严格的IP范围 -->
            </networks>
            
            <!-- 使用只读profile -->
            <profile>readonly</profile>
            
            <!-- 使用限制性配额 -->
            <quota>readonly_quota</quota>
            
            <!-- 数据库访问权限（可选，在配置文件中权限控制有限） -->
            <!-- 更细粒度的权限建议使用SQL GRANT命令 -->
        </dev>
    </users>

    <profiles>
        <!-- 只读profile详细配置 -->
        <readonly>
            <!-- 强制只读 -->
            <readonly>2</readonly>  <!-- 2表示只读，且不能修改设置 -->
            
            <!-- 查询限制 -->
            <max_memory_usage>5000000000</max_memory_usage>      <!-- 5GB -->
            <max_execution_time>30</max_execution_time>          <!-- 30秒 -->
            <timeout_before_checking_execution_speed>10</timeout_before_checking_execution_speed>
            
            <!-- 读取限制 -->
            <max_rows_to_read>50000000</max_rows_to_read>        <!-- 5000万行 -->
            <max_bytes_to_read>5000000000</max_bytes_to_read>    <!-- 5GB -->
            
            <!-- 结果集限制 -->
            <max_result_rows>500000</max_result_rows>            <!-- 50万行 -->
            <max_result_bytes>500000000</max_result_bytes>       <!-- 500MB -->
            
            <!-- 防止复杂查询 -->
            <max_ast_depth>50</max_ast_depth>
            <max_expanded_ast_elements>250000</max_expanded_ast_elements>
            <max_query_size>262144</max_query_size>              <!-- 256KB -->
            
            <!-- 性能设置 -->
            <use_uncompressed_cache>0</use_uncompressed_cache>
            <merge_tree_max_rows_to_use_cache>0</merge_tree_max_rows_to_use_cache>
            
            <!-- 禁止某些操作 -->
            <force_index_by_date>0</force_index_by_date>
            <force_primary_key>0</force_primary_key>
        </readonly>
    </profiles>

    <quotas>
        <!-- 只读用户配额 -->
        <readonly_quota>
            <interval>
                <duration>3600</duration>      <!-- 1小时 -->
                <queries>1000</queries>        <!-- 最多1000次查询 -->
                <errors>50</errors>            <!-- 最多50个错误 -->
                <result_rows>1000000</result_rows>     <!-- 最多返回100万行 -->
                <read_rows>50000000</read_rows>        <!-- 最多读取5000万行 -->
                <execution_time>300</execution_time>   <!-- 总执行时间300秒 -->
            </interval>
            <interval>
                <duration>86400</duration>     <!-- 24小时 -->
                <queries>10000</queries>       <!-- 每天最多10000次查询 -->
                <read_rows>200000000</read_rows>       <!-- 每天最多读取2亿行 -->
            </interval>
        </readonly_quota>
    </quotas>
</yandex>
EOF
```

#### 2. 生成SHA256密码哈希

```bash
# 生成密码的SHA256哈希
echo -n "dev_password_123" | sha256sum | awk '{print $1}'
# 输出示例：e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855

# 或者使用clickhouse-client生成
echo -n "dev_password_123" | clickhouse-client --query "SELECT hex(SHA256('dev_password_123'))"
```

### 方法4：使用SQL管理只读用户权限

```sql
-- 1. 创建只读用户并授予精确权限
CREATE USER dev IDENTIFIED WITH sha256_password BY 'dev_password_123';

-- 2. 授予查看数据库的权限
GRANT SHOW DATABASES ON *.* TO dev;

-- 3. 授予特定数据库的SELECT权限
-- 假设我们有这些数据库
GRANT SELECT ON system.* TO dev;           -- 只读系统表
GRANT SELECT ON default.* TO dev;          -- 只读默认数据库
GRANT SELECT ON analytics.* TO dev;        -- 只读分析数据库

-- 4. 授予特定表的只读权限（更精确控制）
GRANT SELECT ON analytics.sales TO dev;
GRANT SELECT ON analytics.users TO dev;
GRANT SELECT ON analytics.products TO dev;

-- 5. 授予查看表结构的权限
GRANT SHOW TABLES ON *.* TO dev;
GRANT SHOW COLUMNS ON *.* TO dev;

-- 6. 设置只读限制
ALTER USER dev SETTINGS readonly = 1;

-- 7. 创建只读角色（更便于管理）
CREATE ROLE read_only;
GRANT SELECT ON *.* TO read_only;
GRANT SHOW DATABASES ON *.* TO read_only;
GRANT read_only TO dev;

-- 8. 验证权限
SHOW GRANTS FOR dev;
```

### 方法5：使用角色管理只读权限

```sql
-- 1. 创建只读角色
CREATE ROLE readonly_role;

-- 2. 授予角色权限
GRANT SHOW DATABASES ON *.* TO readonly_role;
GRANT SELECT ON default.* TO readonly_role;
GRANT SELECT ON analytics.* TO readonly_role;

-- 3. 创建用户并分配角色
CREATE USER dev 
    IDENTIFIED WITH sha256_password BY 'dev_password_123'
    DEFAULT ROLE readonly_role;

-- 4. 或者将现有用户加入角色
GRANT readonly_role TO dev;

-- 5. 设置用户级别的只读限制
ALTER USER dev SETTINGS 
    readonly = 1,
    max_memory_usage = 10000000000,
    max_execution_time = 30;
```

### 验证配置

#### 1. 重启ClickHouse并验证

```bash
# 重启服务
sudo systemctl restart clickhouse-server

# 等待服务启动
sleep 5

# 验证服务状态
sudo systemctl status clickhouse-server
```

#### 2. 测试只读用户

```bash
# 测试dev用户连接
clickhouse-client --user dev --password dev_password_123 --host localhost

# 在ClickHouse中运行测试
-- 测试读取权限
SELECT currentUser();           -- 应该显示dev
SHOW DATABASES;                 -- 应该能看到数据库列表
SELECT * FROM system.users;     -- 应该能读取系统表

-- 测试写入权限（应该失败）
CREATE DATABASE test_db;        -- 应该报错：Not enough privileges
INSERT INTO some_table VALUES (1);  -- 应该报错：Cannot execute query in readonly mode
DROP TABLE some_table;          -- 应该报错：Not enough privileges
```

### 3. 验证脚本

```bash
#!/bin/bash
# validate_dev_user.sh

echo "验证dev只读用户配置..."

# 测试读取操作
echo "1. 测试读取权限:"
clickhouse-client --user dev --password dev_password_123 --query "
SELECT 
    '读取测试' as 测试项,
    currentUser() as 当前用户,
    '成功' as 状态
LIMIT 1
" 2>&1

# 测试写入操作（应该失败）
echo -e "\n2. 测试写入权限（应该失败）:"
clickhouse-client --user dev --password dev_password_123 --query "
CREATE TABLE IF NOT EXISTS test_readonly (id UInt32) ENGINE = Memory
" 2>&1 | grep -q "Not enough privileges\|readonly" && echo "✓ 写入被正确拒绝" || echo "✗ 写入不应该成功"

# 查看用户权限
echo -e "\n3. 查看dev用户权限:"
clickhouse-client --user admin --password admin_password --query "
SHOW GRANTS FOR dev
"

# 查看用户设置
echo -e "\n4. 查看dev用户设置:"
clickhouse-client --user admin --password admin_password --query "
SELECT 
    name,
    value,
    changed
FROM system.settings
WHERE name IN ('readonly', 'max_memory_usage', 'max_execution_time')
  AND name IN (SELECT name FROM system.settings WHERE name LIKE 'profile%')
UNION ALL
SELECT 
    'profile' as name,
    profile as value,
    0 as changed
FROM system.users
WHERE name = 'dev'
"
```

### 最佳实践建议

#### 1. 安全建议

```bash
# 1. 使用强密码
# 密码应包含大小写字母、数字和特殊字符，长度至少12位

# 2. 限制网络访问
# 只允许必要的IP地址访问

# 3. 定期轮换密码
# 建议每90天更换一次密码

# 4. 监控用户活动
sudo tee /etc/clickhouse-server/users.d/dev_monitoring.xml > /dev/null <<'EOF'
<yandex>
    <users>
        <dev>
            <!-- 添加审计设置 -->
            <allow_introspection_functions>0</allow_introspection_functions>
            <log_queries>1</log_queries>  <!-- 记录查询日志 -->
            <log_query_threads>1</log_query_threads>
        </dev>
    </users>
</yandex>
EOF
```

#### 2. 生产环境配置示例

```xml
<!-- /etc/clickhouse-server/users.d/dev_production.xml -->
<yandex>
    <users>
        <dev>
            <!-- 生产环境使用加密密码 -->
            <password_sha256_hex>8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92</password_sha256_hex>
            
            <!-- 严格限制网络 -->
            <networks>
                <ip>10.10.0.0/16</ip>      <!-- 数据中心内部 -->
                <ip>172.16.0.0/12</ip>     <!-- 办公网络 -->
            </networks>
            
            <!-- 生产环境只读profile -->
            <profile>production_readonly</profile>
            
            <!-- 专门的只读配额 -->
            <quota>production_readonly_quota</quota>
            
            <!-- 启用查询日志 -->
            <log_queries>1</log_queries>
        </dev>
    </users>
    
    <profiles>
        <production_readonly>
            <readonly>2</readonly>  <!-- 严格只读 -->
            <max_memory_usage>20000000000</max_memory_usage>  <!-- 20GB -->
            <max_execution_time>120</max_execution_time>      <!-- 2分钟 -->
            <max_rows_to_read>1000000000</max_rows_to_read>   <!-- 10亿行 -->
            <max_result_rows>10000000</max_result_rows>       <!-- 1000万行 -->
            <!-- 禁止可能影响性能的操作 -->
            <distributed_ddl_task_timeout>0</distributed_ddl_task_timeout>
            <skip_unavailable_shards>1</skip_unavailable_shards>
        </production_readonly>
    </profiles>
</yandex>
```

### 故障排除

#### 1. 用户无法连接
```bash
# 检查网络配置
clickhouse-client --user admin --query "
SELECT user_name, host_ip 
FROM system.user_direct_grants 
WHERE user_name = 'dev'
"

# 检查防火墙
sudo iptables -L -n | grep 9000
sudo ufw status
```

#### 2. 用户无法读取数据
```bash
# 检查权限
clickhouse-client --user admin --query "
SHOW GRANTS FOR dev
"

# 检查profile设置
clickhouse-client --user admin --query "
SELECT 
    name,
    value
FROM system.settings 
WHERE name = 'readonly' 
  AND user = 'dev'
"
```

#### 3. 查看日志
```bash
# 查看ClickHouse日志中的认证错误
sudo grep -i "dev" /var/log/clickhouse-server/clickhouse-server.log | tail -20

# 查看查询拒绝日志
sudo grep -i "readonly\|denied" /var/log/clickhouse-server/clickhouse-server.log | tail -20
```

## 1. 基础SQL用户管理

### 1.1 创建用户并限制IP

```sql
-- 使用管理员用户登录（如default）
clickhouse-client --user default

-- 查询当前用户
SELECT currentUser();

-- 创建用户并限制特定IP
CREATE USER dev IDENTIFIED WITH sha256_password BY 'dev_password_123'
HOST IP '192.168.1.100';  -- 只允许特定IP

-- 或者允许IP段
CREATE USER analyst IDENTIFIED WITH sha256_password BY 'analyst_pass'
HOST IP '192.168.1.0/24', IP '10.0.0.0/8', LOCAL;

-- 允许特定域名
CREATE USER api_user IDENTIFIED WITH sha256_password BY 'api_pass'
HOST NAME 'app-server.example.com', NAME '*.example.com';

-- 允许本地和特定IP
CREATE USER admin IDENTIFIED WITH sha256_password BY 'admin_pass'
HOST LOCAL, IP '10.10.1.100', IP '192.168.100.0/24';
```

### 1.2 HOST参数详解

| HOST类型 | 语法 | 说明 | 示例 |
|---------|------|------|------|
| 特定IP | `IP '192.168.1.100'` | 单个IP地址 | `IP '10.0.0.5'` |
| IP网段 | `IP '192.168.1.0/24'` | CIDR格式的网络 | `IP '10.0.0.0/8'` |
| 本地 | `LOCAL` | 本地连接（127.0.0.1） | `LOCAL` |
| 任意 | `ANY` | 任意IP（不推荐） | `ANY` |
| 无限制 | `NONE` | 禁止所有连接 | `NONE` |
| 域名 | `NAME 'host.example.com'` | 域名（需要DNS解析） | `NAME '*.example.com'` |

## 2. 完整权限管理流程

### 2.1 创建用户并授予精确权限

```sql
-- 1. 创建只读用户dev，限制内网访问
CREATE USER dev IDENTIFIED WITH sha256_password BY 'SecurePass123!'
HOST IP '192.168.1.0/24', IP '10.0.0.0/8', LOCAL
SETTINGS readonly = 1;

-- 2. 授予数据库访问权限
GRANT SHOW DATABASES ON *.* TO dev;

-- 3. 授予特定数据库的SELECT权限
GRANT SELECT ON default.* TO dev;
GRANT SELECT ON analytics.* TO dev;

-- 4. 授予系统表只读权限（用于监控）
GRANT SELECT ON system.* TO dev;

-- 5. 授予特定表的只读权限（更精确控制）
GRANT SELECT ON analytics.sales_data TO dev;
GRANT SELECT ON analytics.user_logs TO dev;

-- 6. 授予查看表结构的权限
GRANT SHOW TABLES ON analytics.* TO dev;
GRANT SHOW COLUMNS ON analytics.* TO dev;
```

### 2.2 创建角色进行权限管理

```sql
-- 1. 创建只读角色
CREATE ROLE read_only_role
SETTINGS readonly = 1;

-- 2. 为角色授予权限
GRANT SHOW DATABASES ON *.* TO read_only_role;
GRANT SELECT ON default.* TO read_only_role;
GRANT SELECT ON analytics.* TO read_only_role;
GRANT SELECT ON system.* TO read_only_role;

-- 3. 创建用户并分配角色
CREATE USER dev_ro IDENTIFIED WITH sha256_password BY 'RolePass123!'
HOST IP '192.168.1.0/24'
DEFAULT ROLE read_only_role;

-- 4. 将现有用户添加到角色
GRANT read_only_role TO dev;
```

## 3. 高级IP限制配置

### 3.1 多个IP和网络段

```sql
-- 用户可以从多个网络连接
CREATE USER support_engineer 
IDENTIFIED WITH sha256_password BY 'SupportPass!'
HOST 
    IP '192.168.1.0/24',      -- 办公室网络
    IP '10.10.0.0/16',        -- 数据中心
    IP '172.16.100.50',       -- 特定服务器
    LOCAL,                    -- 本地管理
    NAME 'vpn.company.com';   -- VPN服务器

-- 授予适当权限
GRANT SELECT ON system.* TO support_engineer;
GRANT SELECT ON logs.* TO support_engineer;
```

### 3.2 生产环境安全配置

```sql
-- 管理员用户 - 严格IP限制
CREATE USER prod_admin 
IDENTIFIED WITH sha256_password BY 'StrongAdminPass@2024'
HOST 
    IP '10.0.1.100',          -- 跳板机
    IP '10.0.1.101',          -- 管理服务器
    LOCAL                     -- 本地紧急访问
SETTINGS 
    readonly = 0;

-- 授予管理员权限
GRANT ALL ON *.* TO prod_admin WITH GRANT OPTION;

-- BI用户 - 只读，特定网段
CREATE USER bi_user
IDENTIFIED WITH sha256_password BY 'BiViewerPass!'
HOST IP '192.168.2.0/24'     -- BI服务器网段
SETTINGS 
    readonly = 1,
    max_memory_usage = 20000000000;  -- 20GB限制

-- 授予BI相关权限
GRANT SELECT ON data_warehouse.* TO bi_user;
GRANT SELECT ON analytics.* TO bi_user;
```

## 4. 用户权限查询和验证

### 4.1 查看用户IP限制

```sql
-- 查看所有用户的访问限制
SELECT 
    name AS user_name,
    storage,
    auth_type,
    host_ip,
    host_names,
    default_roles_all,
    default_roles_list
FROM system.users
ORDER BY name;

-- 查看用户的详细主机配置
SELECT 
    user_name,
    host_ip,
    host_names,
    granted_role_names
FROM system.user_direct_grants
WHERE host_ip != '' OR host_names != ''
ORDER BY user_name;

-- 查看当前用户的访问限制
SELECT 
    currentUser() AS current_user,
    hostName() AS connected_from,
    getClientAddress() AS client_ip;
```

### 4.2 验证权限

```sql
-- 验证用户权限
SHOW GRANTS FOR dev;

-- 查看用户的角色和权限
SELECT 
    u.name AS user_name,
    r.name AS role_name,
    r.storage AS role_storage
FROM system.users u
LEFT JOIN system.role_grants rg ON u.name = rg.user_name
LEFT JOIN system.roles r ON rg.role_name = r.name
WHERE u.name = 'dev';

-- 查看用户的具体设置
SELECT 
    user,
    name AS setting_name,
    value AS setting_value
FROM system.settings
WHERE user = 'dev'
ORDER BY name;
```

## 5. 修改和更新配置

### 5.1 修改用户IP限制

```sql
-- 修改用户的IP访问限制
ALTER USER dev
HOST 
    IP '10.0.0.0/8',
    IP '192.168.1.0/24',
    IP '172.16.100.0/28',
    LOCAL;

-- 添加新的IP允许
ALTER USER analyst
ADD HOST IP '192.168.2.100';

-- 移除IP限制
ALTER USER api_user
DROP HOST IP '192.168.1.200';

-- 清空所有IP限制（允许所有）
ALTER USER dev HOST ANY;

-- 禁止所有连接
ALTER USER dev HOST NONE;
```

### 5.2 更新用户权限

```sql
-- 授予新权限
GRANT INSERT ON analytics.staging TO dev;
GRANT CREATE TEMPORARY TABLE ON *.* TO dev;

-- 撤销权限
REVOKE DELETE ON analytics.* FROM dev;

-- 修改密码
ALTER USER dev IDENTIFIED WITH sha256_password BY 'NewSecurePass123!';

-- 启用/禁用用户
ALTER USER dev DISABLE;
ALTER USER dev ENABLE;

-- 删除用户
DROP USER dev;
```

## 6. 批量用户管理脚本

### 6.1 批量创建用户

```sql
-- 批量创建开发团队用户
CREATE USER dev1 IDENTIFIED WITH sha256_password BY 'Dev1Pass!'
HOST IP '192.168.1.0/24' DEFAULT ROLE read_only_role;

CREATE USER dev2 IDENTIFIED WITH sha256_password BY 'Dev2Pass!'
HOST IP '192.168.1.0/24' DEFAULT ROLE read_only_role;

CREATE USER dev3 IDENTIFIED WITH sha256_password BY 'Dev3Pass!'
HOST IP '192.168.1.0/24' DEFAULT ROLE read_only_role;

-- 批量授予权限
GRANT SELECT ON development.* TO dev1, dev2, dev3;
```

### 6.2 使用角色批量管理

```sql
-- 1. 创建部门角色
CREATE ROLE dept_analytics_readonly
HOST IP '10.10.0.0/16'
SETTINGS readonly = 1;

-- 2. 为角色授予权限
GRANT SELECT ON analytics.* TO dept_analytics_readonly;
GRANT SELECT ON reporting.* TO dept_analytics_readonly;

-- 3. 批量创建部门用户
CREATE USER analyst_john IDENTIFIED WITH sha256_password BY 'JohnPass123!'
DEFAULT ROLE dept_analytics_readonly;

CREATE USER analyst_jane IDENTIFIED WITH sha256_password BY 'JanePass456!'
DEFAULT ROLE dept_analytics_readonly;

CREATE USER analyst_bob IDENTIFIED WITH sha256_password BY 'BobPass789!'
DEFAULT ROLE dept_analytics_readonly;
```

## 7. 安全审计和监控

### 7.1 用户活动监控

```sql
-- 查看用户连接历史
SELECT 
    user,
    client_address,
    client_name,
    interface,
    initial_user,
    initial_address,
    auth_type,
    connected_at
FROM system.session_log
WHERE connected_at > now() - INTERVAL 1 DAY
ORDER BY connected_at DESC;

-- 查看失败的登录尝试
SELECT 
    auth_id,
    user,
    address,
    interface,
    failed_password_attempts,
    last_failed_attempt
FROM system.user_attempts
WHERE failed_password_attempts > 0
ORDER BY last_failed_attempt DESC;

-- 查询审计日志
SELECT 
    event_time,
    user,
    client_address,
    query_id,
    query_kind,
    databases,
    tables,
    columns,
    exception_code,
    exception
FROM system.query_log
WHERE user = 'dev'
  AND event_time > now() - INTERVAL 1 HOUR
ORDER BY event_time DESC;
```

### 7.2 安全配置检查

```sql
-- 检查安全配置
WITH user_security AS (
    SELECT 
        name AS user_name,
        CASE 
            WHEN auth_type = 'no_password' THEN '✗ 无密码'
            WHEN auth_type = 'plaintext_password' THEN '⚠ 明文密码'
            WHEN auth_type = 'sha256_password' THEN '✓ SHA256密码'
            ELSE auth_type
        END AS auth_security,
        host_ip,
        host_names,
        CASE 
            WHEN host_ip LIKE '%0.0.0.0%' OR host_ip = '' THEN '✗ 无IP限制'
            ELSE '✓ IP受限'
        END AS ip_security,
        storage
    FROM system.users
    WHERE name NOT IN ('default')
)
SELECT * FROM user_security
ORDER BY 
    CASE auth_security 
        WHEN '✗ 无密码' THEN 1
        WHEN '⚠ 明文密码' THEN 2
        ELSE 3 
    END,
    CASE ip_security
        WHEN '✗ 无IP限制' THEN 1
        ELSE 2
    END;
```

## 8. 生产环境最佳实践

### 8.1 完整的用户管理脚本

```sql
-- 生产环境用户管理模板
-- 1. 创建只读角色
CREATE ROLE IF NOT EXISTS prod_readonly
SETTINGS 
    readonly = 1,
    max_memory_usage = 10000000000,
    max_execution_time = 60;

-- 2. 为角色授予权限
GRANT SHOW DATABASES ON *.* TO prod_readonly;
GRANT SELECT ON prod_analytics.* TO prod_readonly;
GRANT SELECT ON prod_reporting.* TO prod_readonly;
GRANT SELECT ON system.* TO prod_readonly;

-- 3. 创建只读用户
CREATE USER IF NOT EXISTS bi_viewer
IDENTIFIED WITH sha256_password BY '${BI_VIEWER_PASSWORD}'
HOST 
    IP '10.20.30.0/24',      -- BI服务器网络
    IP '192.168.100.100'     -- 特定BI服务器
DEFAULT ROLE prod_readonly
SETTINGS 
    max_rows_to_read = 1000000000,
    quota = 'bi_quota';

-- 4. 创建ETL用户
CREATE USER IF NOT EXISTS etl_loader
IDENTIFIED WITH sha256_password BY '${ETL_PASSWORD}'
HOST 
    IP '10.20.40.0/24'      -- ETL服务器网络
SETTINGS 
    readonly = 0;

-- 5. 授予ETL权限
GRANT INSERT, SELECT ON prod_staging.* TO etl_loader;
GRANT CREATE TEMPORARY TABLE ON *.* TO etl_loader;
```

### 8.2 自动化用户配置脚本

```bash
#!/bin/bash
# configure_users.sh

# 设置变量
CLICKHOUSE_HOST="localhost"
ADMIN_USER="default"
ADMIN_PASS=""

# 用户配置数组
declare -A USERS=(
    ["bi_user"]="BiViewerPass123!@10.20.30.0/24,192.168.100.100"
    ["analyst"]="AnalystPass456!@192.168.1.0/24"
    ["api_user"]="ApiPass789!@10.0.0.0/8"
    ["etl_user"]="EtlPass101!@10.20.40.0/24"
)

# 创建角色
clickhouse-client --host "$CLICKHOUSE_HOST" --user "$ADMIN_USER" --password "$ADMIN_PASS" --query "
CREATE ROLE IF NOT EXISTS read_only_role
SETTINGS readonly = 1;

GRANT SELECT ON analytics.* TO read_only_role;
GRANT SELECT ON reporting.* TO read_only_role;
"

# 创建用户
for user in "${!USERS[@]}"; do
    IFS='@' read -r password hosts <<< "${USERS[$user]}"
    
    echo "创建用户: $user"
    
    # 解析hosts
    IFS=',' read -ra HOST_ARRAY <<< "$hosts"
    HOST_CLAUSE=""
    for host in "${HOST_ARRAY[@]}"; do
        if [[ $host =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+(/[0-9]+)?$ ]]; then
            HOST_CLAUSE+="IP '$host', "
        else
            HOST_CLAUSE+="NAME '$host', "
        fi
    done
    HOST_CLAUSE="${HOST_CLAUSE%, }"  # 移除最后的逗号
    
    # 创建用户
    clickhouse-client --host "$CLICKHOUSE_HOST" --user "$ADMIN_USER" --password "$ADMIN_PASS" --query "
    CREATE USER IF NOT EXISTS $user
    IDENTIFIED WITH sha256_password BY '$password'
    HOST $HOST_CLAUSE
    DEFAULT ROLE read_only_role;
    "
done

echo "用户配置完成"
```

## 9. 故障排除

### 9.1 常见连接问题

```sql
-- 检查用户是否能连接
SELECT 
    '连接测试' AS test,
    currentUser() AS current_user,
    hostName() AS server_host,
    getClientAddress() AS client_ip;

-- 检查用户IP是否在允许列表中
SELECT 
    u.name AS user_name,
    ug.host_ip AS allowed_ips,
    ug.host_names AS allowed_hosts,
    CASE 
        WHEN position(getClientAddress() as String IN ug.host_ip) > 0 
            OR ug.host_ip = '' 
            OR ug.host_ip = '::/0' 
        THEN '允许'
        ELSE '拒绝'
    END AS access_status
FROM system.users u
JOIN system.user_direct_grants ug ON u.name = ug.user_name
WHERE u.name = currentUser();
```

### 9.2 权限问题排查

```sql
-- 查看用户所有权限
SELECT 
    '直接权限' AS grant_type,
    database,
    table,
    column,
    access_type,
    is_partial_revoke
FROM system.grants
WHERE user_name = 'dev'

UNION ALL

-- 查看通过角色获得的权限
SELECT 
    '角色权限' AS grant_type,
    g.database,
    g.table,
    g.column,
    g.access_type,
    g.is_partial_revoke
FROM system.grants g
JOIN system.role_grants rg ON g.role_name = rg.granted_role_name
WHERE rg.user_name = 'dev'

ORDER BY grant_type, database, table;
```

## 重要提醒

1. **生产环境安全**：
   - 始终使用`sha256_password`加密方式
   - 为每个用户设置强密码
   - 严格限制IP访问范围
   - 定期审计用户权限

2. **备份用户配置**：
   ```sql
   -- 备份用户配置到SQL文件
   SELECT 
       'CREATE USER ' || name || 
       ' IDENTIFIED WITH sha256_password BY \'[PASSWORD]\'' ||
       ' HOST ' || host_ip || ';' AS create_user_sql
   FROM system.users
   WHERE storage = 'sql';
   ```

3. **版本兼容性**：
   - SQL用户管理需要ClickHouse 20.5+
   - 某些高级特性需要更新版本
   - 检查ClickHouse版本：`SELECT version()`
