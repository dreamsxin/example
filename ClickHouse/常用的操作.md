## 系统表
- system.users: 包含用户元数据。
- system.roles: 包含角色信息。
- system.role_grants: 关联用户和角色。
- system.privileges: 包含系统级权限详情。
- system.table_privileges, system.database_privileges：用于查看表和数据库级别的权限。

## 1. 数据库操作

### 创建数据库
```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS db_name;

-- 指定引擎创建数据库（如 Atomic）
CREATE DATABASE IF NOT EXISTS db_name 
ENGINE = Atomic;
```

### 查看数据库
```sql
-- 查看所有数据库
SHOW DATABASES;

-- 查看数据库详情
SELECT name, engine, data_path, metadata_path 
FROM system.databases;
```

### 删除数据库
```sql
DROP DATABASE IF EXISTS db_name;
```

### 用户

```sql
-- 列出用户
SHOW USERS;
-- 或者使用系统表
SELECT name FROM system.users;

-- 查看用户拥有的权限
SHOW GRANTS FOR username;
-- 查看角色权限
SHOW GRANTS FOR role_name;
```

## 2. 表操作

### 创建表
```sql
-- 基本创建表
CREATE TABLE IF NOT EXISTS table_name
(
    id UInt32,
    name String,
    age UInt8,
    event_date Date,
    created_at DateTime
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(event_date)
ORDER BY (id, event_date)
SETTINGS index_granularity = 8192;

-- 创建分布式表
CREATE TABLE distributed_table AS local_table
ENGINE = Distributed(cluster_name, database, local_table, rand());
```

### 修改表
```sql
-- 添加列
ALTER TABLE table_name ADD COLUMN new_column String;

-- 删除列
ALTER TABLE table_name DROP COLUMN column_name;

-- 修改列类型
ALTER TABLE table_name MODIFY COLUMN column_name UInt64;

-- 重命名列
ALTER TABLE table_name RENAME COLUMN old_name TO new_name;

-- 添加注释
ALTER TABLE table_name COMMENT COLUMN column_name '列注释';
```

### 删除表
```sql
-- 删除表
DROP TABLE IF EXISTS table_name;

-- 清空表数据（不删除表结构）
TRUNCATE TABLE table_name;
```

### 重命名表
```sql
RENAME TABLE old_name TO new_name;
```

## 3. 索引操作

### 创建索引
```sql
-- 创建主键索引（在建表时指定）
CREATE TABLE table_name
(
    ...
) ENGINE = MergeTree()
ORDER BY (id, timestamp);  -- ORDER BY 就是主键

-- 创建跳数索引
CREATE TABLE table_name
(
    id UInt32,
    name String,
    age UInt8,
    INDEX idx_age age TYPE minmax GRANULARITY 1,
    INDEX idx_name name TYPE bloom_filter GRANULARITY 1
) ENGINE = MergeTree()
ORDER BY id;

-- 添加跳数索引
ALTER TABLE table_name ADD INDEX idx_name name TYPE bloom_filter GRANULARITY 1;
```

### 删除索引
```sql
ALTER TABLE table_name DROP INDEX idx_name;
```

### 物化视图（类似索引）
```sql
CREATE MATERIALIZED VIEW mv_name
ENGINE = MergeTree()
ORDER BY (date, id)
AS 
SELECT date, id, count() as cnt
FROM source_table
GROUP BY date, id;
```

## 4. 查看信息

### 列出表
```sql
-- 查看所有表
SHOW TABLES;

-- 查看特定数据库的表
SHOW TABLES FROM database_name;

-- 使用系统表查看
SELECT name, engine, create_time
FROM system.tables
WHERE database = 'database_name';
```

### 查看表结构
```sql
-- 查看表结构
DESCRIBE table_name;

-- 查看详细结构（含类型、默认值等）
DESCRIBE TABLE table_name;

-- 查看建表语句
SHOW CREATE TABLE table_name;
```

### 查看表大小
```sql
-- 查看表大小和行数
SELECT 
    table,
    formatReadableSize(sum(bytes)) as size,
    sum(rows) as rows,
    max(modification_time) as latest_modification
FROM system.parts
WHERE database = 'database_name' AND table = 'table_name'
  AND active
GROUP BY table;

-- 查看所有表大小
SELECT 
    database,
    table,
    formatReadableSize(sum(bytes)) as size,
    sum(rows) as rows,
    count() as parts
FROM system.parts
WHERE active
GROUP BY database, table
ORDER BY sum(bytes) DESC;
```

### 查看数据库大小
```sql
-- 查看数据库大小
SELECT 
    database,
    formatReadableSize(sum(bytes)) as size,
    formatReadableSize(sum(primary_key_bytes_in_memory)) as primary_key_size,
    sum(rows) as rows,
    count() as tables
FROM system.parts
WHERE active
GROUP BY database
ORDER BY sum(bytes) DESC;
```

## 5. 分区管理

### 查看分区信息
```sql
-- 查看表分区信息
SELECT 
    partition,
    name,
    rows,
    formatReadableSize(bytes_on_disk) as size,
    active
FROM system.parts
WHERE database = 'database_name' AND table = 'table_name'
ORDER BY partition;

-- 查看分区键
SELECT partition_key
FROM system.tables
WHERE database = 'database_name' AND name = 'table_name';
```

### 分区操作
```sql
-- 删除分区
ALTER TABLE table_name DROP PARTITION '2023-01';

-- 卸载分区
ALTER TABLE table_name DETACH PARTITION '2023-01';

-- 加载分区
ALTER TABLE table_name ATTACH PARTITION '2023-01';
```

## 6. 系统监控

### 查看查询日志
```sql
-- 查看正在运行的查询
SHOW PROCESSLIST;

-- 查看查询历史
SELECT 
    query,
    query_duration_ms,
    memory_usage,
    read_rows,
    read_bytes
FROM system.query_log
WHERE event_date = today()
ORDER BY query_start_time DESC
LIMIT 10;
```

### 查看系统状态
```sql
-- 查看 MergeTree 表状态
SELECT *
FROM system.merges
WHERE database = 'database_name';

-- 查看表统计信息
SELECT *
FROM system.tables
WHERE database = 'database_name';
```

## 7. 实用函数

### 格式转换
```sql
-- 字节大小可读格式
SELECT formatReadableSize(123456789); -- 117.74 MiB

-- 数字格式化
SELECT formatReadableQuantity(1234567); -- 1.23 million
```

### 系统函数
```sql
-- 查看版本
SELECT version();

-- 查看集群
SELECT * FROM system.clusters;

-- 查看设置
SHOW SETTINGS LIKE '%merge%';
```

## 常用技巧

1. **查看表占用磁盘**：
```sql
SELECT 
    table,
    disk_name,
    formatReadableSize(sum(bytes_on_disk)) as size
FROM system.parts
WHERE active
GROUP BY table, disk_name;
```

2. **查看列信息**：
```sql
SELECT 
    name,
    type,
    default_kind,
    default_expression
FROM system.columns
WHERE database = 'database_name' AND table = 'table_name';
```

3. **优化表**：
```sql
-- 后台合并
OPTIMIZE TABLE table_name FINAL;

-- 指定分区合并
OPTIMIZE TABLE table_name PARTITION '2023-01' FINAL;
```
