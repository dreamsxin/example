## 1. **k6** - 推荐首选

k6 对 CSV 参数化有很好的支持，是现代化的性能测试工具。

### 安装
```bash
# 使用包管理器
brew install k6

# 或使用 Docker
docker pull grafana/k6
```

### 使用示例
```javascript
// script.js
import { check } from 'k6';
import http from 'k6/http';
import { SharedArray } from 'k6/data';
import papaparse from 'https://jslib.k6.io/papaparse/5.1.1/index.js';

// 读取 CSV 文件
const csvData = new SharedArray('users', function() {
  return papaparse.parse(open('./users.csv'), { header: true }).data;
});

export const options = {
  stages: [
    { duration: '30s', target: 10 },
    { duration: '1m', target: 10 },
    { duration: '30s', target: 0 },
  ],
};

export default function () {
  // 获取当前虚拟用户的数据
  const user = csvData[__VU % csvData.length];
  
  const payload = JSON.stringify({
    username: user.username,
    email: user.email,
    role: user.role
  });

  const params = {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${user.token}`
    },
  };

  const res = http.post('https://api.example.com/users', payload, params);
  
  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });
}
```

### CSV 文件格式 (users.csv)
```csv
username,email,role,token
john_doe,john@example.com,user,token123
jane_smith,jane@example.com,admin,token456
bob_wilson,bob@example.com,user,token789
```

### 运行测试
```bash
k6 run script.js
```

## 2. **Apache JMeter** - 企业级解决方案

JMeter 对 CSV 参数化有非常成熟的支持。

### 使用步骤：
1. 创建 `CSV Data Set Config`
2. 配置 CSV 文件路径和变量名
3. 在请求中使用 `${变量名}` 引用

### CSV 配置示例：
```xml
<CSVDataSet>
  <filename>users.csv</filename>
  <variableNames>username,email,role,token</variableNames>
  <ignoreFirstLine>true</ignoreFirstLine>
  <delimiter>,</delimiter>
</CSVDataSet>
```

### 在 HTTP 请求中使用：
```xml
<HTTPSampler>
  <method>POST</method>
  <path>/api/users</path>
  <Arguments>
    <Argument>
      <name>username</name>
      <value>${username}</value>
    </Argument>
    <Argument>
      <name>email</name>
      <value>${email}</value>
    </Argument>
  </Arguments>
  <HeaderManager>
    <headers>
      <Header>
        <name>Authorization</name>
        <value>Bearer ${token}</value>
      </Header>
    </headers>
  </HeaderManager>
</HTTPSampler>
```

## 3. **Gatling** - Scala 编写的高性能工具

Gatling 也提供了优秀的 CSV 支持。

### Scala 脚本示例：
```scala
import io.gatling.core.Predef._
import io.gatling.http.Predef._
import scala.concurrent.duration._

class CsvParameterization extends Simulation {

  val httpProtocol = http
    .baseUrl("https://api.example.com")
    .acceptHeader("application/json")

  // 读取 CSV 文件
  val csvFeeder = csv("users.csv").circular

  val scn = scenario("CSV Parameter Test")
    .feed(csvFeeder)
    .exec(
      http("Create User")
        .post("/users")
        .header("Authorization", "Bearer ${token}")
        .body(StringBody(
          """{
            | "username": "${username}",
            | "email": "${email}",
            | "role": "${role}"
            |}""".stripMargin))
        .asJson
        .check(status.is(200))
    )

  setUp(
    scn.inject(
      rampUsers(100) during (30 seconds)
    )
  ).protocols(httpProtocol)
}
```

## 4. **Artillery** - Node.js 压测工具

Artillery 支持 YAML 配置和 CSV 数据。

### 配置示例 (artillery.yml)：
```yaml
config:
  target: "https://api.example.com"
  phases:
    - duration: 60
      arrivalRate: 10
  payload:
    path: "users.csv"
    fields:
      - "username"
      - "email"
      - "role"
      - "token"

scenarios:
  - flow:
    - post:
        url: "/users"
        headers:
          Content-Type: "application/json"
          Authorization: "Bearer {{ token }}"
        json:
          username: "{{ username }}"
          email: "{{ email }}"
          role: "{{ role }}"
```

### 运行
```bash
artillery run artillery.yml
```

## 5. **工具对比**

| 工具 | 语言 | CSV支持 | 学习曲线 | 性能 | 推荐场景 |
|------|------|---------|----------|------|----------|
| **k6** | JavaScript | ⭐⭐⭐⭐⭐ | 中等 | 高 | 现代化项目，CI/CD |
| **JMeter** | Java | ⭐⭐⭐⭐⭐ | 陡峭 | 中 | 企业级复杂测试 |
| **Gatling** | Scala | ⭐⭐⭐⭐ | 陡峭 | 很高 | 高性能需求 |
| **Artillery** | Node.js | ⭐⭐⭐⭐ | 简单 | 中 | 快速原型 |

## 推荐选择

- **首选 k6**：现代化，良好的 CSV 支持，性能优秀
- **企业级选 JMeter**：功能最全面，社区成熟
- **高性能选 Gatling**：性能最佳，适合大规模测试
- **快速上手选 Artillery**：配置简单，学习成本低

k6 在易用性和功能之间提供了最好的平衡，特别适合需要 CSV 参数化的 HTTP 压测场景。
