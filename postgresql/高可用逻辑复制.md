# 设置逻辑复制

本文使用两台主机来演示PG的逻辑复制：

- 10.0.32.37：主节点，数据发布端
- 10.0.32.36：从节点，数据订阅端

## 配置

启用逻辑复制非常简单，设置PG的系统参数wal_level为logical即可。可在SQL控制台通过以下命令修改：
```sql
alter system set wal_level = logical;
```
也可以修改配置并重启
`postgresql.conf` 并设置如下参数：
```conf
wal_level = logical			# minimal, replica, or logical
```

## 创建数据发布者

登录主节点创建数据库：
```shell
psql -h 10.0.32.35 -U devuser -d watch_log -W
```
创建数据发布者
```sql
create publication custom_watch_log for table l_basic, l_contact; -- 多张表使用英文逗号分隔列出
```
默认PG只对insert、delete语句进行逻辑复制，若需要对其它DML语句也先进逻辑复制需要设置表的replica identity [option]属性。
```sql
alter table l_basic replica identity full ;
```

## 创建数据订阅者
使用具有superuser权限的用户登录需要设置为数据订阅者的数据库：
```shell
psql -h 10.0.32.36 -U devuser -d watch_log -W
```
PG的逻辑复制不会同步DDL语句，需要自行创建表结构。
```sql
create subscription full_watch_log connection 'host=10.0.32.37 port=5432 dbname=watch_log user=devuser password=dbuser.password' publication full_watch_log;
```

