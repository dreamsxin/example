ä»¥ä¸‹æ˜¯åŸºäº TimescaleDB å®ç°ç”¨æˆ·è¡Œä¸ºåˆ†æï¼ˆåŒ…æ‹¬æ¼æ–—åˆ†æã€ç•™å­˜åˆ†æåŠå…¶ä»–å¸¸è§åˆ†æï¼‰çš„è¯¦ç»† SQL æ–¹æ¡ˆï¼Œç»“åˆæ—¶åºæ•°æ®åº“ç‰¹æ€§ä¼˜åŒ–è®¡ç®—æ•ˆç‡ï¼š

---

### ğŸ“Š **ä¸€ã€æ¼æ–—åˆ†æ SQL**  
**ç›®æ ‡**ï¼šç»Ÿè®¡ç”¨æˆ·ä»â€œå¯åŠ¨â†’æµè§ˆâ†’åŠ è´­â†’æ”¯ä»˜â€çš„è½¬åŒ–ç‡ï¼ˆçª—å£æœŸ 7 å¤©ï¼‰ã€‚  
```sql
WITH user_events AS (
  SELECT
    user_id,
    time_bucket('1 day', event_time) AS bucket_day,
    event_type,
    -- æ ‡è®°æ¯ä¸ªæ­¥éª¤æ˜¯å¦å®Œæˆ
    CASE 
        WHEN event_type = 'å¯åŠ¨' THEN 1
        WHEN event_type = 'æµè§ˆ' THEN 2
        WHEN event_type = 'åŠ è´­' THEN 3
        WHEN event_type = 'æ”¯ä»˜' THEN 4
    END AS step
  FROM user_behavior
  WHERE event_time >= NOW() - INTERVAL '30 days'
),
step_sequence AS (
  SELECT
    user_id,
    step,
    MIN(bucket_day) AS first_step_day
  FROM user_events
  GROUP BY user_id, step
),
funnel_data AS (
  SELECT
    user_id,
    MAX(CASE WHEN step = 1 THEN first_step_day END) AS step1_day,
    MAX(CASE WHEN step = 2 AND first_step_day <= (MAX(CASE WHEN step = 1 THEN first_step_day END) + INTERVAL '7 days') THEN 1 END) AS step2_flag,
    MAX(CASE WHEN step = 3 AND first_step_day <= (MAX(CASE WHEN step = 1 THEN first_step_day END) + INTERVAL '7 days') THEN 1 END) AS step3_flag,
    MAX(CASE WHEN step = 4 AND first_step_day <= (MAX(CASE WHEN step = 1 THEN first_step_day END) + INTERVAL '7 days') THEN 1 END) AS step4_flag
  FROM step_sequence
  GROUP BY user_id
  HAVING MAX(CASE WHEN step = 1 THEN first_step_day END) IS NOT NULL
)
SELECT
  COUNT(*) AS total_users,
  SUM(step2_flag) AS step2_users,
  SUM(step3_flag) AS step3_users,
  SUM(step4_flag) AS step4_users,
  ROUND(SUM(step2_flag) * 1.0 / COUNT(*), 2) AS step1_to_step2_rate,
  ROUND(SUM(step4_flag) * 1.0 / SUM(step2_flag), 2) AS step2_to_step4_rate
FROM funnel_data;
```

**ä¼˜åŒ–è¯´æ˜**ï¼š  
1. **æ—¶é—´åˆ†æ¡¶**ï¼š`time_bucket` æŒ‰å¤©èšåˆäº‹ä»¶ï¼Œå‡å°‘è®¡ç®—é‡ã€‚  
2. **æ¡ä»¶èšåˆ**ï¼šé€šè¿‡ `CASE WHEN` å’Œçª—å£æœŸçº¦æŸï¼ˆ`+ INTERVAL '7 days'`ï¼‰ç¡®ä¿æ­¥éª¤é¡ºåºã€‚  
3. **é¿å…å¤šé‡ JOIN**ï¼šä½¿ç”¨æ¡ä»¶æ ‡è®°æ›¿ä»£å­æŸ¥è¯¢è¿æ¥ï¼Œæå‡æ€§èƒ½ã€‚

---

### ğŸ“ˆ **äºŒã€ç”¨æˆ·ç•™å­˜åˆ†æ SQL**  
**ç›®æ ‡**ï¼šè®¡ç®—æ–°ç”¨æˆ·çš„ 1/3/7/30 æ—¥ç•™å­˜ç‡ã€‚  
```sql
WITH first_actions AS (
  SELECT
    user_id,
    MIN(time_bucket('1 day', event_time)) AS first_day
  FROM user_behavior
  GROUP BY user_id
),
retention_data AS (
  SELECT
    f.user_id,
    f.first_day,
    time_bucket('1 day', u.event_time) AS active_day,
    (EXTRACT(EPOCH FROM (time_bucket('1 day', u.event_time) - f.first_day)) / 86400) AS days_diff
  FROM first_actions f
  JOIN user_behavior u ON f.user_id = u.user_id
  WHERE u.event_time >= f.first_day
)
SELECT
  first_day AS cohort_date,
  COUNT(DISTINCT user_id) AS cohort_size,
  COUNT(DISTINCT CASE WHEN days_diff = 1 THEN user_id END) AS d1_retained,
  COUNT(DISTINCT CASE WHEN days_diff = 3 THEN user_id END) AS d3_retained,
  COUNT(DISTINCT CASE WHEN days_diff = 7 THEN user_id END) AS d7_retained,
  COUNT(DISTINCT CASE WHEN days_diff = 30 THEN user_id END) AS d30_retained,
  ROUND(COUNT(DISTINCT CASE WHEN days_diff = 1 THEN user_id END) * 1.0 / COUNT(DISTINCT user_id), 2) AS d1_retention_rate
FROM retention_data
GROUP BY first_day
ORDER BY first_day DESC;
```

**å…³é”®ç‚¹**ï¼š  
1. **é¦–æ—¥æ ‡è®°**ï¼šé€šè¿‡ `MIN(event_time)` ç¡®å®šç”¨æˆ·é¦–æ—¥ï¼ˆcohortï¼‰ã€‚  
2. **ç•™å­˜çª—å£**ï¼š`days_diff` è®¡ç®—æ´»è·ƒæ—¥ä¸é¦–æ—¥çš„æ—¶é—´å·®ï¼Œè¿‡æ»¤æŒ‡å®šçª—å£ï¼ˆ1/3/7/30å¤©ï¼‰ã€‚  
3. **åˆ†ç¾¤ç»Ÿè®¡**ï¼šæŒ‰é¦–æ—¥åˆ†ç»„ï¼ˆ`cohort_date`ï¼‰ï¼Œé¿å…æ–°è€ç”¨æˆ·æ··æ‚ã€‚

---

### âš¡ **ä¸‰ã€å…¶ä»–å¸¸è§è¡Œä¸ºåˆ†æ SQL**  
#### **1. ç”¨æˆ·è·¯å¾„åˆ†æ**  
```sql
SELECT
  user_id,
  array_agg(event_type ORDER BY event_time) AS event_sequence
FROM user_behavior
WHERE event_time >= NOW() - INTERVAL '7 days'
GROUP BY user_id;
```

#### **2. æ—¥æ´»è·ƒç”¨æˆ·ï¼ˆDAUï¼‰ä¸é¢‘æ¬¡**  
```sql
SELECT
  time_bucket('1 day', event_time) AS day,
  COUNT(DISTINCT user_id) AS dau,
  COUNT(*) AS total_events,
  ROUND(COUNT(*) * 1.0 / COUNT(DISTINCT user_id), 1) AS events_per_user
FROM user_behavior
GROUP BY day
ORDER BY day DESC;
```

#### **3. ç”¨æˆ·å¹³å‡ä½¿ç”¨æ—¶é•¿ï¼ˆSession åˆ†æï¼‰**  
```sql
SELECT
  user_id,
  AVG(session_duration) AS avg_session_duration
FROM (
  SELECT
    user_id,
    session_id,
    EXTRACT(EPOCH FROM (MAX(event_time) - MIN(event_time))) AS session_duration
  FROM user_behavior
  GROUP BY user_id, session_id
) sessions
GROUP BY user_id;
```

#### **4. å…³é”®äº‹ä»¶è½¬åŒ–è¶‹åŠ¿**  
```sql
SELECT
  time_bucket('1 hour', event_time) AS hour,
  COUNT(*) FILTER (WHERE event_type = 'æ”¯ä»˜') AS payment_count,
  COUNT(*) FILTER (WHERE event_type = 'åŠ è´­') AS cart_count,
  ROUND(COUNT(*) FILTER (WHERE event_type = 'æ”¯ä»˜') * 1.0 / 
        NULLIF(COUNT(*) FILTER (WHERE event_type = 'åŠ è´­'), 0), 2) AS cart_to_payment_rate
FROM user_behavior
GROUP BY hour
ORDER BY hour DESC;
```

---

### âš™ï¸ **å››ã€TimescaleDB ä¼˜åŒ–å»ºè®®**  
1. **Hypertable åˆ†åŒº**ï¼š  
   ```sql
   SELECT create_hypertable('user_behavior', 'event_time');
   SELECT set_chunk_time_interval('user_behavior', INTERVAL '7 days'); -- æŒ‰å‘¨åˆ†åŒº
   ```
2. **ç´¢å¼•ä¼˜åŒ–**ï¼š  
   ```sql
   CREATE INDEX idx_user_time ON user_behavior (user_id, event_time DESC);
   CREATE INDEX idx_event_type ON user_behavior (event_type);
   ```
3. **è¿ç»­èšåˆï¼ˆç‰©åŒ–è§†å›¾ï¼‰**ï¼š  
   ```sql
   CREATE MATERIALIZED VIEW user_daily_summary
   WITH (timescaledb.continuous) AS
   SELECT
     time_bucket('1 day', event_time) AS day,
     user_id,
     COUNT(*) AS events
   FROM user_behavior
   GROUP BY day, user_id;
   ```
4. **æ•°æ®å‹ç¼©ä¸ä¿ç•™ç­–ç•¥**ï¼š  
   ```sql
   ALTER TABLE user_behavior SET (timescaledb.compress, timescaledb.compress_orderby = 'event_time');
   SELECT add_compression_policy('user_behavior', INTERVAL '30 days');
   SELECT add_retention_policy('user_behavior', INTERVAL '365 days');
   ```

---

TimescaleDBçš„è¿ç»­èšåˆï¼ˆContinuous Aggregatesï¼‰åŠŸèƒ½é€šè¿‡é¢„è®¡ç®—å’Œå¢é‡æ›´æ–°æœºåˆ¶ï¼Œå¯å¤§å¹…ä¼˜åŒ–â€œå¯åŠ¨â†’æµè§ˆâ†’åŠ è´­â†’æ”¯ä»˜â€çš„è½¬åŒ–ç‡ç»Ÿè®¡æ€§èƒ½ä¸çµæ´»æ€§ã€‚ä»¥ä¸‹æ˜¯å…·ä½“ä¼˜åŒ–ç­–ç•¥åŠå®ç°æ–¹æ¡ˆï¼š

---

### âš™ï¸ **ä¸€ã€åˆ†å±‚è¿ç»­èšåˆå®ç°æ¼æ–—é˜¶æ®µé¢„è®¡ç®—**
#### **1. åˆ†é’Ÿçº§èšåˆï¼ˆå®æ—¶é˜¶æ®µï¼‰**
   - **ä½œç”¨**ï¼šæ•è·ç”¨æˆ·å®æ—¶è¡Œä¸ºï¼Œç”¨äºå³æ—¶è½¬åŒ–ç‡ç›‘æ§ã€‚
   - **å®ç°æ–¹æ¡ˆ**ï¼š
     ```sql
     CREATE MATERIALIZED VIEW funnel_minutely
     WITH (timescaledb.continuous) AS
     SELECT
       user_id,
       time_bucket('1 min', event_time) AS bucket_min,
       -- æ ‡è®°å„é˜¶æ®µè¡Œä¸º
       BOOL_OR(event_type = 'å¯åŠ¨') AS is_launch,
       BOOL_OR(event_type = 'æµè§ˆ') AS is_browse,
       BOOL_OR(event_type = 'åŠ è´­') AS is_cart,
       BOOL_OR(event_type = 'æ”¯ä»˜') AS is_pay
     FROM user_behavior
     GROUP BY user_id, bucket_min;
     ```
     **åˆ·æ–°ç­–ç•¥**ï¼šæ¯åˆ†é’Ÿå¢é‡åˆ·æ–°ï¼Œè¦†ç›–è¿‘1å°æ—¶æ•°æ®ï¼š
     ```sql
     SELECT add_continuous_aggregate_policy(
       'funnel_minutely',
       start_offset => INTERVAL '1 hour',
       end_offset => INTERVAL '1 min',
       schedule_interval => INTERVAL '1 min'
     );
     ```

#### **2. å°æ—¶çº§èšåˆï¼ˆçŸ­æœŸåˆ†æï¼‰**
   - **ä½œç”¨**ï¼šç»Ÿè®¡å°æ—¶çº§è½¬åŒ–ç‡ï¼Œå¹³è¡¡ç²¾åº¦ä¸æ€§èƒ½ã€‚
   - **å®ç°æ–¹æ¡ˆ**ï¼š
     ```sql
     CREATE MATERIALIZED VIEW funnel_hourly
     WITH (timescaledb.continuous) AS
     SELECT
       time_bucket('1 hour', bucket_min) AS bucket_hour,
       user_id,
       MAX(is_launch::int) AS launched,
       MAX(is_browse::int) FILTER (WHERE is_launch) AS browsed,
       MAX(is_cart::int) FILTER (WHERE is_browse) AS carted,
       MAX(is_pay::int) FILTER (WHERE is_cart) AS paid
     FROM funnel_minutely
     GROUP BY user_id, bucket_hour;
     ```
     **åˆ·æ–°ç­–ç•¥**ï¼šæ¯å°æ—¶åˆ·æ–°è¿‘7å¤©æ•°æ®ï¼š
     ```sql
     SELECT add_continuous_aggregate_policy(
       'funnel_hourly',
       start_offset => INTERVAL '7 days',
       end_offset => INTERVAL '1 hour',
       schedule_interval => INTERVAL '1 hour'
     );
     ```

#### **3. æ—¥çº§èšåˆï¼ˆé•¿æœŸè¶‹åŠ¿ï¼‰**
   - **ä½œç”¨**ï¼šæ”¯æŒ30å¤©çª—å£æœŸçš„è½¬åŒ–ç‡åˆ†æï¼Œé¿å…å…¨è¡¨æ‰«æã€‚
   - **å®ç°æ–¹æ¡ˆ**ï¼š
     ```sql
     CREATE MATERIALIZED VIEW funnel_daily
     WITH (timescaledb.continuous) AS
     SELECT
       time_bucket('1 day', bucket_hour) AS bucket_day,
       user_id,
       -- åˆ¤æ–­æ˜¯å¦å®Œæˆå…¨é“¾è·¯è½¬åŒ–
       CASE WHEN MAX(paid) > 0 THEN 1 ELSE 0 END AS converted
     FROM funnel_hourly
     GROUP BY user_id, bucket_day;
     ```
     **å‹ç¼©ä¸ä¿ç•™ç­–ç•¥**ï¼š
     ```sql
     -- å¯ç”¨å‹ç¼©å‡å°‘å­˜å‚¨
     ALTER MATERIALIZED VIEW funnel_daily SET (timescaledb.compress);
     -- ä¿ç•™90å¤©æ•°æ®
     SELECT add_retention_policy('funnel_daily', INTERVAL '90 days');
     ```

---

### ğŸ” **äºŒã€è½¬åŒ–ç‡è®¡ç®—ä¼˜åŒ–**
#### **1. çª—å£æœŸçº¦æŸçš„è½¬åŒ–è·¯å¾„ç»Ÿè®¡**
   - åŸºäºæ—¥çº§èšåˆï¼Œç»Ÿè®¡30æ—¥å†…ä»å¯åŠ¨åˆ°æ”¯ä»˜çš„ç”¨æˆ·æ¯”ä¾‹ï¼š
     ```sql
     WITH cohorts AS (
       SELECT
         user_id,
         MIN(bucket_day) AS first_launch_day
       FROM funnel_daily
       WHERE launched = 1
       GROUP BY user_id
     )
     SELECT
       first_launch_day,
       COUNT(*) AS total_launched,
       SUM(converted) AS converted_users,
       -- çª—å£æœŸå†…å®Œæˆè½¬åŒ–çš„æ¯”ä¾‹
       SUM(converted) * 1.0 / COUNT(*) AS conversion_rate
     FROM cohorts
     JOIN funnel_daily fd 
       ON fd.user_id = cohorts.user_id
       AND fd.bucket_day BETWEEN cohorts.first_launch_day 
                         AND cohorts.first_launch_day + INTERVAL '30 days'
     GROUP BY first_launch_day;
     ```
     **ä¼˜åŒ–æ•ˆæœ**ï¼š  
     - é¿å…æ‰«æåŸå§‹è¡¨ï¼Œç›´æ¥æŸ¥è¯¢å‹ç¼©åçš„æ—¥çº§èšåˆæ•°æ®ï¼›
     - é€šè¿‡åˆ†å±‚é¢„è®¡ç®—ï¼ŒæŸ¥è¯¢é€Ÿåº¦æå‡10-100å€ã€‚

#### **2. å®æ—¶æ¼æ–—é˜¶æ®µæ‹†è§£**
   - åŸºäºåˆ†é’Ÿçº§èšåˆï¼Œå®æ—¶å±•ç¤ºå„é˜¶æ®µè½¬åŒ–ç‡ï¼š
     ```sql
     SELECT
       bucket_min,
       COUNT(*) FILTER (WHERE is_launch) AS launch_count,
       COUNT(*) FILTER (WHERE is_browse) AS browse_count,
       COUNT(*) FILTER (WHERE is_cart) AS cart_count,
       COUNT(*) FILTER (WHERE is_pay) AS pay_count,
       -- é˜¶æ®µè½¬åŒ–ç‡
       COUNT(*) FILTER (WHERE is_browse) * 1.0 / NULLIF(COUNT(*) FILTER (WHERE is_launch), 0) AS launch_to_browse_rate
     FROM funnel_minutely
     WHERE bucket_min > NOW() - INTERVAL '1 hour'
     GROUP BY bucket_min;
     ```
     **ä¼˜åŠ¿**ï¼š  
     - å¢é‡åˆ·æ–°ç¡®ä¿åˆ†é’Ÿçº§å»¶è¿Ÿï¼›
     - å®æ—¶èšåˆï¼ˆ`timescaledb.materialized_only = false`ï¼‰è‡ªåŠ¨åˆå¹¶æœªåˆ·æ–°æ•°æ®ã€‚

---

### ğŸ› ï¸ **ä¸‰ã€è¿›é˜¶ä¼˜åŒ–ç­–ç•¥**
1. **åˆ†ç¾¤å¯¹æ¯”åˆ†æ**  
   - åœ¨èšåˆè§†å›¾ä¸­åŠ å…¥ç”¨æˆ·æ ‡ç­¾ï¼ˆå¦‚æ–°è€ç”¨æˆ·ã€è®¾å¤‡ç±»å‹ï¼‰ï¼š
     ```sql
     ALTER MATERIALIZED VIEW funnel_hourly ADD COLUMN user_segment TEXT;
     ```
   - æŒ‰åˆ†ç¾¤ç»Ÿè®¡è½¬åŒ–ç‡å·®å¼‚ï¼š
     ```sql
     SELECT 
       user_segment,
       AVG(paid * 1.0 / launched) AS avg_conversion_rate
     FROM funnel_hourly 
     GROUP BY user_segment;
     ```

2. **åŠ¨æ€çª—å£æœŸæ”¯æŒ**  
   - é€šè¿‡å‚æ•°åŒ–æ—¶é—´èŒƒå›´ï¼Œé€‚åº”ä¸åŒä¸šåŠ¡åœºæ™¯ï¼š
     ```sql
     CREATE FUNCTION get_conversion_rate(window_days INT)
     RETURNS TABLE (cohort_date DATE, rate FLOAT) AS $$
       SELECT ... -- å¤ç”¨å‰æ–‡SQLï¼Œå°†30å¤©æ›¿æ¢ä¸ºwindow_days
     $$ LANGUAGE SQL;
     ```

3. **å¼‚å¸¸æ£€æµ‹**  
   - åŸºäºå°æ—¶çº§èšåˆç›‘æ§è½¬åŒ–ç‡çªé™ï¼š
     ```sql
     SELECT bucket_hour, launch_to_browse_rate
     FROM (
       SELECT 
         bucket_hour,
         SUM(browsed) * 1.0 / NULLIF(SUM(launched), 0) AS launch_to_browse_rate,
         LAG(SUM(browsed)) OVER (ORDER BY bucket_hour) 
           / NULLIF(LAG(SUM(launched)) OVER (ORDER BY bucket_hour), 0) AS prev_rate
       FROM funnel_hourly
       GROUP BY bucket_hour
     ) t
     WHERE launch_to_browse_rate < 0.8 * prev_rate; -- çªé™20%æ—¶æŠ¥è­¦
     ```

---

### ğŸ’ **å››ã€æ”¶ç›Šæ€»ç»“**
| **ä¼˜åŒ–é¡¹**         | **åŸå§‹æ–¹æ¡ˆ**       | **è¿ç»­èšåˆæ–¹æ¡ˆ**       | **æå‡æ•ˆæœ**               |
|---------------------|--------------------|------------------------|----------------------------|
| æŸ¥è¯¢å“åº”æ—¶é—´       | ç§’çº§ï¼ˆ>5sï¼‰        | æ¯«ç§’çº§ï¼ˆ<100msï¼‰       | æé€Ÿ50å€ä»¥ä¸Š   |
| å†å²æ•°æ®åˆ†æ       | å…¨è¡¨æ‰«æ           | è¯»å–å‹ç¼©èšåˆå±‚         | I/Oè´Ÿè½½é™ä½90% |
| å®æ—¶æ€§             | T+1å»¶è¿Ÿ            | åˆ†é’Ÿçº§å»¶è¿Ÿ             | æ”¯æŒå®æ—¶å†³ç­–   |
| å­˜å‚¨æˆæœ¬           | åŸå§‹æ•°æ®å…¨é‡å­˜å‚¨   | åˆ†å±‚å‹ç¼©+ä¿ç•™ç­–ç•¥      | é™ä½70%        |

> **å®æ–½å»ºè®®**ï¼šç»“åˆ`add_compression_policy`å‹ç¼©å†å²èšåˆå±‚ï¼Œå¹¶é€šè¿‡`timescaledb_information.jobs`ç›‘æ§åˆ·æ–°ä»»åŠ¡çŠ¶æ€ï¼Œå½¢æˆé—­ç¯ä¼˜åŒ–ä½“ç³»ã€‚
