ä»¥ä¸‹æ˜¯åŸºäº TimescaleDB å®ç°ç”¨æˆ·è¡Œä¸ºåˆ†æï¼ˆåŒ…æ‹¬æ¼æ–—åˆ†æã€ç•™å­˜åˆ†æåŠå…¶ä»–å¸¸è§åˆ†æï¼‰çš„è¯¦ç»† SQL æ–¹æ¡ˆï¼Œç»“åˆæ—¶åºæ•°æ®åº“ç‰¹æ€§ä¼˜åŒ–è®¡ç®—æ•ˆç‡ï¼š

---

### ğŸ“Š **ä¸€ã€æ¼æ–—åˆ†æ SQL**  
**ç›®æ ‡**ï¼šç»Ÿè®¡ç”¨æˆ·ä»â€œå¯åŠ¨â†’æµè§ˆâ†’åŠ è´­â†’æ”¯ä»˜â€çš„è½¬åŒ–ç‡ï¼ˆçª—å£æœŸ 7 å¤©ï¼‰ã€‚  
```sql
WITH user_events AS (
  SELECT
    user_id,
    time_bucket('1 day', event_time) AS bucket_day,
    event_type,
    -- æ ‡è®°æ¯ä¸ªæ­¥éª¤æ˜¯å¦å®Œæˆ
    CASE 
        WHEN event_type = 'å¯åŠ¨' THEN 1
        WHEN event_type = 'æµè§ˆ' THEN 2
        WHEN event_type = 'åŠ è´­' THEN 3
        WHEN event_type = 'æ”¯ä»˜' THEN 4
    END AS step
  FROM user_behavior
  WHERE event_time >= NOW() - INTERVAL '30 days'
),
step_sequence AS (
  SELECT
    user_id,
    step,
    MIN(bucket_day) AS first_step_day
  FROM user_events
  GROUP BY user_id, step
),
funnel_data AS (
  SELECT
    user_id,
    MAX(CASE WHEN step = 1 THEN first_step_day END) AS step1_day,
    MAX(CASE WHEN step = 2 AND first_step_day <= (MAX(CASE WHEN step = 1 THEN first_step_day END) + INTERVAL '7 days') THEN 1 END) AS step2_flag,
    MAX(CASE WHEN step = 3 AND first_step_day <= (MAX(CASE WHEN step = 1 THEN first_step_day END) + INTERVAL '7 days') THEN 1 END) AS step3_flag,
    MAX(CASE WHEN step = 4 AND first_step_day <= (MAX(CASE WHEN step = 1 THEN first_step_day END) + INTERVAL '7 days') THEN 1 END) AS step4_flag
  FROM step_sequence
  GROUP BY user_id
  HAVING MAX(CASE WHEN step = 1 THEN first_step_day END) IS NOT NULL
)
SELECT
  COUNT(*) AS total_users,
  SUM(step2_flag) AS step2_users,
  SUM(step3_flag) AS step3_users,
  SUM(step4_flag) AS step4_users,
  ROUND(SUM(step2_flag) * 1.0 / COUNT(*), 2) AS step1_to_step2_rate,
  ROUND(SUM(step4_flag) * 1.0 / SUM(step2_flag), 2) AS step2_to_step4_rate
FROM funnel_data;
```

**ä¼˜åŒ–è¯´æ˜**ï¼š  
1. **æ—¶é—´åˆ†æ¡¶**ï¼š`time_bucket` æŒ‰å¤©èšåˆäº‹ä»¶ï¼Œå‡å°‘è®¡ç®—é‡ã€‚  
2. **æ¡ä»¶èšåˆ**ï¼šé€šè¿‡ `CASE WHEN` å’Œçª—å£æœŸçº¦æŸï¼ˆ`+ INTERVAL '7 days'`ï¼‰ç¡®ä¿æ­¥éª¤é¡ºåºã€‚  
3. **é¿å…å¤šé‡ JOIN**ï¼šä½¿ç”¨æ¡ä»¶æ ‡è®°æ›¿ä»£å­æŸ¥è¯¢è¿æ¥ï¼Œæå‡æ€§èƒ½ã€‚

---

### ğŸ“ˆ **äºŒã€ç”¨æˆ·ç•™å­˜åˆ†æ SQL**  
**ç›®æ ‡**ï¼šè®¡ç®—æ–°ç”¨æˆ·çš„ 1/3/7/30 æ—¥ç•™å­˜ç‡ã€‚  
```sql
WITH first_actions AS (
  SELECT
    user_id,
    MIN(time_bucket('1 day', event_time)) AS first_day
  FROM user_behavior
  GROUP BY user_id
),
retention_data AS (
  SELECT
    f.user_id,
    f.first_day,
    time_bucket('1 day', u.event_time) AS active_day,
    (EXTRACT(EPOCH FROM (time_bucket('1 day', u.event_time) - f.first_day)) / 86400) AS days_diff
  FROM first_actions f
  JOIN user_behavior u ON f.user_id = u.user_id
  WHERE u.event_time >= f.first_day
)
SELECT
  first_day AS cohort_date,
  COUNT(DISTINCT user_id) AS cohort_size,
  COUNT(DISTINCT CASE WHEN days_diff = 1 THEN user_id END) AS d1_retained,
  COUNT(DISTINCT CASE WHEN days_diff = 3 THEN user_id END) AS d3_retained,
  COUNT(DISTINCT CASE WHEN days_diff = 7 THEN user_id END) AS d7_retained,
  COUNT(DISTINCT CASE WHEN days_diff = 30 THEN user_id END) AS d30_retained,
  ROUND(COUNT(DISTINCT CASE WHEN days_diff = 1 THEN user_id END) * 1.0 / COUNT(DISTINCT user_id), 2) AS d1_retention_rate
FROM retention_data
GROUP BY first_day
ORDER BY first_day DESC;
```

**å…³é”®ç‚¹**ï¼š  
1. **é¦–æ—¥æ ‡è®°**ï¼šé€šè¿‡ `MIN(event_time)` ç¡®å®šç”¨æˆ·é¦–æ—¥ï¼ˆcohortï¼‰ã€‚  
2. **ç•™å­˜çª—å£**ï¼š`days_diff` è®¡ç®—æ´»è·ƒæ—¥ä¸é¦–æ—¥çš„æ—¶é—´å·®ï¼Œè¿‡æ»¤æŒ‡å®šçª—å£ï¼ˆ1/3/7/30å¤©ï¼‰ã€‚  
3. **åˆ†ç¾¤ç»Ÿè®¡**ï¼šæŒ‰é¦–æ—¥åˆ†ç»„ï¼ˆ`cohort_date`ï¼‰ï¼Œé¿å…æ–°è€ç”¨æˆ·æ··æ‚ã€‚

---

### âš¡ **ä¸‰ã€å…¶ä»–å¸¸è§è¡Œä¸ºåˆ†æ SQL**  
#### **1. ç”¨æˆ·è·¯å¾„åˆ†æ**  
```sql
SELECT
  user_id,
  array_agg(event_type ORDER BY event_time) AS event_sequence
FROM user_behavior
WHERE event_time >= NOW() - INTERVAL '7 days'
GROUP BY user_id;
```

#### **2. æ—¥æ´»è·ƒç”¨æˆ·ï¼ˆDAUï¼‰ä¸é¢‘æ¬¡**  
```sql
SELECT
  time_bucket('1 day', event_time) AS day,
  COUNT(DISTINCT user_id) AS dau,
  COUNT(*) AS total_events,
  ROUND(COUNT(*) * 1.0 / COUNT(DISTINCT user_id), 1) AS events_per_user
FROM user_behavior
GROUP BY day
ORDER BY day DESC;
```

#### **3. ç”¨æˆ·å¹³å‡ä½¿ç”¨æ—¶é•¿ï¼ˆSession åˆ†æï¼‰**  
```sql
SELECT
  user_id,
  AVG(session_duration) AS avg_session_duration
FROM (
  SELECT
    user_id,
    session_id,
    EXTRACT(EPOCH FROM (MAX(event_time) - MIN(event_time))) AS session_duration
  FROM user_behavior
  GROUP BY user_id, session_id
) sessions
GROUP BY user_id;
```

#### **4. å…³é”®äº‹ä»¶è½¬åŒ–è¶‹åŠ¿**  
```sql
SELECT
  time_bucket('1 hour', event_time) AS hour,
  COUNT(*) FILTER (WHERE event_type = 'æ”¯ä»˜') AS payment_count,
  COUNT(*) FILTER (WHERE event_type = 'åŠ è´­') AS cart_count,
  ROUND(COUNT(*) FILTER (WHERE event_type = 'æ”¯ä»˜') * 1.0 / 
        NULLIF(COUNT(*) FILTER (WHERE event_type = 'åŠ è´­'), 0), 2) AS cart_to_payment_rate
FROM user_behavior
GROUP BY hour
ORDER BY hour DESC;
```

---

### âš™ï¸ **å››ã€TimescaleDB ä¼˜åŒ–å»ºè®®**  
1. **Hypertable åˆ†åŒº**ï¼š  
   ```sql
   SELECT create_hypertable('user_behavior', 'event_time');
   SELECT set_chunk_time_interval('user_behavior', INTERVAL '7 days'); -- æŒ‰å‘¨åˆ†åŒº
   ```
2. **ç´¢å¼•ä¼˜åŒ–**ï¼š  
   ```sql
   CREATE INDEX idx_user_time ON user_behavior (user_id, event_time DESC);
   CREATE INDEX idx_event_type ON user_behavior (event_type);
   ```
3. **è¿ç»­èšåˆï¼ˆç‰©åŒ–è§†å›¾ï¼‰**ï¼š  
   ```sql
   CREATE MATERIALIZED VIEW user_daily_summary
   WITH (timescaledb.continuous) AS
   SELECT
     time_bucket('1 day', event_time) AS day,
     user_id,
     COUNT(*) AS events
   FROM user_behavior
   GROUP BY day, user_id;
   ```
4. **æ•°æ®å‹ç¼©ä¸ä¿ç•™ç­–ç•¥**ï¼š  
   ```sql
   ALTER TABLE user_behavior SET (timescaledb.compress, timescaledb.compress_orderby = 'event_time');
   SELECT add_compression_policy('user_behavior', INTERVAL '30 days');
   SELECT add_retention_policy('user_behavior', INTERVAL '365 days');
   ```

---

ä»¥ä¸Šæ–¹æ¡ˆå……åˆ†åˆ©ç”¨ TimescaleDB çš„**æ—¶é—´åˆ†æ¡¶**ã€**è¿ç»­èšåˆ**å’Œ**åˆ†åŒºç®¡ç†**ç‰¹æ€§ï¼Œæ˜¾è‘—æå‡æµ·é‡ç”¨æˆ·è¡Œä¸ºæ•°æ®çš„åˆ†ææ•ˆç‡ã€‚å®é™…éƒ¨ç½²æ—¶éœ€æ ¹æ®æ•°æ®é‡è°ƒæ•´åˆ†åŒºé—´éš”ï¼ˆ`chunk_time_interval`ï¼‰å’Œèšåˆç­–ç•¥ã€‚
